<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± WebSocket</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .connected {
            background: #d4edda;
            color: #155724;
        }
        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #dee2e6;
        }
        .log-entry.success {
            color: #28a745;
        }
        .log-entry.error {
            color: #dc3545;
        }
        .log-entry.info {
            color: #17a2b8;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        input {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin: 5px;
            width: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”Œ Ø§Ø®ØªØ¨Ø§Ø± WebSocket - Ù†Ø¸Ø§Ù… Pipefy</h1>
        
        <div id="status" class="status disconnected">
            ØºÙŠØ± Ù…ØªØµÙ„
        </div>

        <div style="margin: 20px 0;">
            <input type="text" id="token" placeholder="Ø£Ø¯Ø®Ù„ Token Ù‡Ù†Ø§" style="width: 80%;">
            <br>
            <button onclick="connectSocket()">Ø§ØªØµØ§Ù„</button>
            <button onclick="disconnectSocket()">Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„</button>
            <button onclick="clearLog()">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
        </div>

        <div style="margin: 20px 0;">
            <input type="text" id="processId" placeholder="Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©" value="your-process-id">
            <button onclick="joinProcess()">Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¹Ù…Ù„ÙŠØ©</button>
            <button onclick="leaveProcess()">Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
        </div>

        <div class="log" id="log">
            <div class="log-entry info">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„...</div>
        </div>
    </div>

    <script>
        let socket = null;

        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString('ar-EG')}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function updateStatus(connected) {
            const status = document.getElementById('status');
            if (connected) {
                status.className = 'status connected';
                status.textContent = 'âœ… Ù…ØªØµÙ„';
            } else {
                status.className = 'status disconnected';
                status.textContent = 'âŒ ØºÙŠØ± Ù…ØªØµÙ„';
            }
        }

        function connectSocket() {
            const token = document.getElementById('token').value;
            
            if (!token) {
                addLog('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Token Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }

            addLog('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…...', 'info');

            socket = io('http://192.168.56.1:3004', {
                auth: {
                    token: token
                },
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                addLog('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                updateStatus(true);
            });

            socket.on('disconnect', (reason) => {
                addLog(`ğŸ‘‹ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„: ${reason}`, 'error');
                updateStatus(false);
            });

            socket.on('error', (error) => {
                addLog(`âŒ Ø®Ø·Ø£: ${error.message || error}`, 'error');
            });

            socket.on('joined-process', (data) => {
                addLog(`âœ… ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¹Ù…Ù„ÙŠØ©: ${data.processId}`, 'success');
            });

            socket.on('left-process', (data) => {
                addLog(`ğŸ‘‹ ØªÙ… Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${data.processId}`, 'info');
            });

            socket.on('ticket-created', (data) => {
                addLog(`ğŸ« ØªØ°ÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©: ${data.ticket.title}`, 'success');
                console.log('Ticket created:', data);
            });

            socket.on('ticket-updated', (data) => {
                addLog(`ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ°ÙƒØ±Ø©: ${data.ticket.title}`, 'info');
                console.log('Ticket updated:', data);
            });

            socket.on('ticket-moved', (data) => {
                addLog(`ğŸ”„ ØªÙ… Ù†Ù‚Ù„ Ø§Ù„ØªØ°ÙƒØ±Ø© Ù…Ù† "${data.from_stage.name}" Ø¥Ù„Ù‰ "${data.to_stage.name}"`, 'info');
                console.log('Ticket moved:', data);
            });

            socket.on('ticket-deleted', (data) => {
                addLog(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ°ÙƒØ±Ø©: ${data.ticket_number}`, 'error');
                console.log('Ticket deleted:', data);
            });

            socket.on('connect_error', (error) => {
                addLog(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}`, 'error');
            });
        }

        function disconnectSocket() {
            if (socket) {
                socket.disconnect();
                addLog('ğŸ”Œ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', 'info');
                updateStatus(false);
            }
        }

        function joinProcess() {
            const processId = document.getElementById('processId').value;
            
            if (!socket || !socket.connected) {
                addLog('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }

            if (!processId) {
                addLog('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'error');
                return;
            }

            socket.emit('join-process', { processId });
            addLog(`ğŸ“¥ Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¹Ù…Ù„ÙŠØ©: ${processId}`, 'info');
        }

        function leaveProcess() {
            const processId = document.getElementById('processId').value;
            
            if (!socket || !socket.connected) {
                addLog('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }

            if (!processId) {
                addLog('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'error');
                return;
            }

            socket.emit('leave-process', { processId });
            addLog(`ğŸ“¤ Ø·Ù„Ø¨ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${processId}`, 'info');
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="log-entry info">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„...</div>';
        }

        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…ÙÙŠØ¯Ø©
        addLog('ğŸ’¡ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Token:', 'info');
        addLog('1. Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…', 'info');
        addLog('2. Ø§ÙØªØ­ Console (F12)', 'info');
        addLog('3. Ø§ÙƒØªØ¨: localStorage.getItem("token")', 'info');
        addLog('4. Ø§Ù†Ø³Ø® Ø§Ù„Ù€ Token ÙˆØ£Ù„ØµÙ‚Ù‡ Ø£Ø¹Ù„Ø§Ù‡', 'info');
    </script>
</body>
</html>

