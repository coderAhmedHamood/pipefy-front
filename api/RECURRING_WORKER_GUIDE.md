# ๐ ุฏููู Worker ุงูุชุฐุงูุฑ ุงููุชูุฑุฑุฉ

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅูุดุงุก ูุธุงู Worker ูุณุชูู ููุญุต ูุชูููุฐ ุงูุชุฐุงูุฑ ุงููุชูุฑุฑุฉ ุชููุงุฆูุงู. ูุนูู ูุฐุง ุงููุธุงู ุจุดูู ูููุตู ุชูุงูุงู ุนู ุงูุฎุงุฏู ุงูุฑุฆูุณู ููููู ุชุดุบููู ูู Process ูููุตู.

## ๐ฏ ุงููููุฒุงุช

โ **ูุณุชูู ุชูุงูุงู** - ูุนูู ูู Process ูููุตู  
โ **ุฃุฏุงุก ุนุงูู** - ูุญุต ุณุฑูุน ูู ุฏูููุฉ ุจุฏูู ุชูุงููู ุนุงููุฉ  
โ **ุจุณูุท ูุบูุฑ ูุนูุฏ** - ูุง ูุชุทูุจ Redis ุฃู MongoDB ุฃู ุฃู ุฎุฏูุงุช ุฅุถุงููุฉ  
โ **ุขูู** - ูุณุชุฎุฏู Transactions ูุถูุงู ุชูุงูู ุงูุจูุงูุงุช  
โ **ูุฑู** - ูููู ุชุฎุตูุต ูุชุฑุฉ ุงููุญุต  

## ๐ ุงููููุงุช ุงููููุดุฃุฉ

### 1. `services/RecurringExecutionService.js`
ุฎุฏูุฉ ุชุญุชูู ุนูู ููุทู ุชูููุฐ ููุงุนุฏ ุงูุชูุฑุงุฑ. ูููู ุงุณุชุฎุฏุงููุง ูู Worker ุฃู ูู ุฃู ููุงู ุขุฎุฑ ูู ุงูุชุทุจูู.

**ุงููุธุงุฆู ุงูุฑุฆูุณูุฉ:**
- `executeRule(ruleId, executedByUserId)` - ุชูููุฐ ูุงุนุฏุฉ ุชูุฑุงุฑ ูุงุญุฏุฉ
- `getDueRules()` - ุฌูุจ ุงูููุงุนุฏ ุงููุณุชุญูุฉ ููุชูููุฐ

### 2. `workers/recurring-tickets-worker.js`
Worker ุงูุฑุฆูุณู ุงูุฐู ูุนูู ูู ุงูุฎูููุฉ ูููุญุต ุงูููุงุนุฏ ุงููุณุชุญูุฉ ุจุดูู ุฏูุฑู.

**ุงููุธุงุฆู:**
- ูุญุต ุฏูุฑู ููููุงุนุฏ ุงููุณุชุญูุฉ
- ุชูููุฐ ุงูููุงุนุฏ ุชููุงุฆูุงู
- ุนุฑุถ ุฅุญุตุงุฆูุงุช ุฏูุฑูุฉ
- ูุนุงูุฌุฉ ุขููุฉ ููุฅุบูุงู

### 3. `workers/README.md`
ุฏููู ุงุณุชุฎุฏุงู Worker.

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### ุงูุชุดุบูู ุงูุฃุณุงุณู

```bash
npm run worker:recurring
```

### ุงูุชุดุบูู ูู ูุถุน ุงูุชุทููุฑ

```bash
npm run worker:recurring:dev
```

### ุงูุชูููู

ูููู ุชุฎุตูุต ูุชุฑุฉ ุงููุญุต ุนุจุฑ ูุชุบูุฑ ุงูุจูุฆุฉ ูู `.env`:

```env
RECURRING_WORKER_INTERVAL=60000  # ุจุงููููู ุซุงููุฉ (ุงูุชุฑุงุถู: 60000 = 60 ุซุงููุฉ)
```

## ๐ ุขููุฉ ุงูุนูู

### 1. ุงููุญุต ุงูุฏูุฑู

Worker ููุญุต ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ุฏูููุฉ (ุฃู ุญุณุจ ุงูุชูููู) ููุจุญุซ ุนู ููุงุนุฏ ุงูุชูุฑุงุฑ ุงููุณุชุญูุฉ.

### 2. ูุนุงููุฑ ุงูุงุณุชุญูุงู

ุงููุงุนุฏุฉ ุชุนุชุจุฑ ูุณุชุญูุฉ ููุชูููุฐ ุฅุฐุง:
- `is_active = true`
- `next_execution <= NOW()`
- ูู ุชุตู ููุญุฏ ุงูุฃูุตู: `execution_count < max_executions` (ุฃู `max_executions IS NULL`)

### 3. ุนูููุฉ ุงูุชูููุฐ

ููู ูุงุนุฏุฉ ูุณุชุญูุฉ:

1. **ุฌูุจ ูุงุนุฏุฉ ุงูุชูุฑุงุฑ** ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
2. **ุงูุชุญูู ูู ุงูุญุฏ ุงูุฃูุตู** - ุฅุฐุง ูุตูุช ููุญุฏ ุงูุฃูุตูุ ูุชู ุชุนุทูููุง
3. **ุชุฌููุฒ ุจูุงูุงุช ุงูุชุฐูุฑุฉ** ูู ุงููุงูุจ (ูุน ูุนุงูุฌุฉ ุงููุชุบูุฑุงุช ูุซู `{{current_date}}`)
4. **ุชุญุฏูุฏ ุงููุฑุญูุฉ** - ุงุณุชุฎุฏุงู ุงููุฑุญูุฉ ุงููุญุฏุฏุฉ ุฃู ุงููุฑุญูุฉ ุงูุฃูููุฉ
5. **ุชุญุฏูุฏ ุงููุณุชุฎุฏู ุงูููุณูุฏ** (ุฅู ูุฌุฏ)
6. **ุฅูุดุงุก ุงูุชุฐูุฑุฉ** ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
7. **ุฅูุดุงุก ุงูุฅุณูุงุฏ** (ุฅู ูุฌุฏ ูุณุชุฎุฏู ููุณูุฏ)
8. **ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุชูุฑุงุฑ**:
   - ุฒูุงุฏุฉ `execution_count`
   - ุชุญุฏูุซ `last_executed` ุฅูู NOW()
   - ุญุณุงุจ `next_execution` ุงูุชุงูู
   - ุชุนุทูู ุงููุงุนุฏุฉ ุฅุฐุง ูุตูุช ููุญุฏ ุงูุฃูุตู

### 4. ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

- ูู ุญุงูุฉ ุญุฏูุซ ุฎุทุฃุ ูุชู Rollback ููู Transaction
- ูุชู ุชุณุฌูู ุงูุฎุทุฃ ูู Console
- Worker ูุณุชูุฑ ูู ุงูุนูู ุญุชู ุจุนุฏ ุงูุฃุฎุทุงุก

## ๐ ุงูุฅุญุตุงุฆูุงุช

Worker ูุนุฑุถ ุฅุญุตุงุฆูุงุช ูู 5 ุฏูุงุฆู:
- ุฅุฌูุงูู ุงููุญูุตุงุช
- ุฅุฌูุงูู ุงูุชูููุฐุงุช ุงููุงุฌุญุฉ
- ุฅุฌูุงูู ุงูุฃุฎุทุงุก
- ุขุฎุฑ ูุญุต ูุขุฎุฑ ุชูููุฐ

## ๐ง ุงูุงุณุชุฎุฏุงู ูู Production

### 1. ุงุณุชุฎุฏุงู PM2 (ููุตู ุจู)

```bash
# ุชุซุจูุช PM2
npm install -g pm2

# ุชุดุบูู Worker
pm2 start workers/recurring-tickets-worker.js --name recurring-worker

# ุญูุธ ุงูุฅุนุฏุงุฏุงุช
pm2 save

# ุฅุนุฏุงุฏ ุงูุชุดุบูู ุงูุชููุงุฆู ุนูุฏ ุฅุนุงุฏุฉ ุงูุชุดุบูู
pm2 startup
```

### 2. ุงุณุชุฎุฏุงู systemd (Linux)

ุฅูุดุงุก ููู `/etc/systemd/system/recurring-worker.service`:

```ini
[Unit]
Description=Recurring Tickets Worker
After=network.target postgresql.service

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/api
Environment="NODE_ENV=production"
Environment="RECURRING_WORKER_INTERVAL=60000"
ExecStart=/usr/bin/node workers/recurring-tickets-worker.js
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

ุซู:
```bash
sudo systemctl enable recurring-worker
sudo systemctl start recurring-worker
sudo systemctl status recurring-worker
```

### 3. ุงุณุชุฎุฏุงู Supervisor

ุฅูุดุงุก ููู `/etc/supervisor/conf.d/recurring-worker.conf`:

```ini
[program:recurring-worker]
command=/usr/bin/node /path/to/api/workers/recurring-tickets-worker.js
directory=/path/to/api
autostart=true
autorestart=true
user=your-user
environment=NODE_ENV=production,RECURRING_WORKER_INTERVAL=60000
stdout_logfile=/var/log/recurring-worker.log
stderr_logfile=/var/log/recurring-worker-error.log
```

ุซู:
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start recurring-worker
```

## โ๏ธ ููุงุญุธุงุช ูุงูุฉ

1. **ูุง ุชูู ุจุชุดุบูู ุฃูุซุฑ ูู Worker ูุงุญุฏ** - ูุฏ ูุคุฏู ุฐูู ุฅูู ุชูููุฐ ูุฒุฏูุฌ ููููุงุนุฏ
2. **ุชุฃูุฏ ูู ุงุชุตุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช** ูุจู ุชุดุบูู Worker
3. **ุงุณุชุฎุฏู Transaction-safe tools** (ูุซู PM2) ูู Production
4. **ุฑุงูุจ ุงูุณุฌูุงุช** ุจุงูุชุธุงู ููุชุฃูุฏ ูู ุนูู Worker ุจุดูู ุตุญูุญ

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### Worker ูุง ูููุฐ ุงูููุงุนุฏ

1. ุชุญูู ูู ุฃู Worker ูุนูู: ุงุจุญุซ ุนู ุฑุณุงุฆู "๐ ุชู ุงูุนุซูุฑ ุนูู..." ูู Console
2. ุชุญูู ูู ุฃู ุงูููุงุนุฏ ูุดุทุฉ: `SELECT * FROM recurring_rules WHERE is_active = true`
3. ุชุญูู ูู `next_execution`: ูุฌุจ ุฃู ูููู ูู ุงููุงุถู ุฃู ุงูุขู
4. ุชุญูู ูู `max_executions`: ุชุฃูุฏ ูู ุฃู `execution_count < max_executions`

### ุฃุฎุทุงุก ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

1. ุชุญูู ูู ุงุชุตุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู `.env`
2. ุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู ุนูู ุฌุฏูู `recurring_rules`
3. ุฑุงุฌุน ุณุฌูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุฃุฎุทุงุก ูู ุฅูุดุงุก ุงูุชุฐุงูุฑ

1. ุชุญูู ูู ูุฌูุฏ ูุฑุญูุฉ ุฃูููุฉ ููุนูููุฉ
2. ุชุญูู ูู ูุฌูุฏ ุงููุณุชุฎุฏู ุงูููุณูุฏ (ุฅู ูุฌุฏ)
3. ุฑุงุฌุน ุณุฌูุงุช Worker ูู Console

## ๐ ุฃูุซูุฉ ุนูู ุงูุณุฌูุงุช

### Worker ูุนูู ุจุดูู ุทุจูุนู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุจุฏุก Worker ููุชุฐุงูุฑ ุงููุชูุฑุฑุฉ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โฑ๏ธ  ูุชุฑุฉ ุงููุญุต: 60 ุซุงููุฉ
๐ ุณูุชู ูุญุต ุงูููุงุนุฏ ุงููุณุชุญูุฉ ูู 60 ุซุงููุฉ

๐ [2025-12-18 12:00:00] ุชู ุงูุนุซูุฑ ุนูู 2 ูุงุนุฏุฉ ูุณุชุญูุฉ ููุชูููุฐ
   โ๏ธ  ุฌุงุฑู ุชูููุฐ ุงููุงุนุฏุฉ: ุชุฐูุฑุฉ ููููุฉ (3d3c7f92...)
   โ ุชู ุชูููุฐ ุงููุงุนุฏุฉ ุจูุฌุงุญ
      ๐ ุงูุชุฐูุฑุฉ: ุนูู-000001
      ๐ข ุงูุชูููุฐ: 2/5
      โญ๏ธ  ุงูุชูููุฐ ุงูุชุงูู: 2025-12-19 12:00:00
```

### Worker ูุน ุฅุญุตุงุฆูุงุช

```
๐ ุฅุญุตุงุฆูุงุช Worker:
   - ุฅุฌูุงูู ุงููุญูุตุงุช: 120
   - ุฅุฌูุงูู ุงูุชูููุฐุงุช: 5
   - ุฅุฌูุงูู ุงูุฃุฎุทุงุก: 0
   - ุขุฎุฑ ูุญุต: 2025-12-18 12:00:00
   - ุขุฎุฑ ุชูููุฐ: 2025-12-18 11:58:00
```

## ๐ ุงูุฑูุงุจุท ุฐุงุช ุงูุตูุฉ

- `POST /api/recurring/rules/{id}/run` - ุชูููุฐ ูุฏูู ููุงุนุฏุฉ ุงูุชูุฑุงุฑ
- `GET /api/recurring/rules/due` - ุฌูุจ ุงูููุงุนุฏ ุงููุณุชุญูุฉ
- `GET /api/recurring/rules` - ุฌูุจ ุฌููุน ููุงุนุฏ ุงูุชูุฑุงุฑ

## ๐ ุงูุฏุนู

ูู ุญุงูุฉ ูุฌูุฏ ูุดุงูู:
1. ุฑุงุฌุน `workers/README.md` ููุชูุงุตูู
2. ุชุญูู ูู ุณุฌูุงุช Worker
3. ุฑุงุฌุน ุฌุฏูู `recurring_rules` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
4. ุชุญูู ูู ุฌุฏูู `tickets` ููุชุญูู ูู ุงูุชุฐุงูุฑ ุงููููุดุฃุฉ

