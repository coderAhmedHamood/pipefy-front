# ุฅุตูุงุญ ูุดููุฉ Duplicate Key ูู ุงููุฑุงุฌุนูู ูุงูุฅุณูุงุฏ

## ๐ ุงููุดููุฉ

ุนูุฏ ุฅุถุงูุฉ ูุฑุงุฌุน ุฃู ูุณุชุฎุฏู ููุณูุฏ ูุชุฐูุฑุฉุ ุซู ุญุฐููุ ูุฅุนุงุฏุฉ ุฅุถุงูุชู ูุฑุฉ ุฃุฎุฑูุ ูุงู ุงููุธุงู ููุธูุฑ ุงูุฎุทุฃ ุงูุชุงูู:

```
ERROR: duplicate key value violates unique constraint
Key (ticket_id, reviewer_id)=(...) already exists
Key (ticket_id, user_id)=(...) already exists
```

### ุงูุณุจุจ ุงูุฌุฐุฑู

- ุงููุธุงู ูุณุชุฎุฏู **Soft Delete** (ุญุฐู ูููู) ุจูุถุน `is_active = false`
- ุงูุณุฌู ุงููุญุฐูู ูุจูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุน ููุณ ุงูููุชุงุญ ุงููุฑูุฏ
- ุนูุฏ ูุญุงููุฉ ุงูุฅุถุงูุฉ ูุฑุฉ ุฃุฎุฑูุ ูุญุฏุซ ุชุถุงุฑุจ ูุน ุงูููุฏ ุงููุฑูุฏ `UNIQUE(ticket_id, reviewer_id)`

## โ ุงูุญู ุงููุทุจู

### 1. ุชุญุฏูุซ Models

#### `TicketReviewer.js`
ุฅุถุงูุฉ ุฏุงูุชูู ุฌุฏูุฏุชูู:

```javascript
// ุงูุจุญุซ ุนู ูุฑุงุฌุน ููุฌูุฏ (ุญุชู ูู ุบูุฑ ูุดุท)
static async findExisting(ticketId, reviewerId)

// ุฅุนุงุฏุฉ ุชูุนูู ูุฑุงุฌุน ูุญุฐูู
static async reactivate(id, updateData)
```

#### `TicketAssignment.js`
ุฅุถุงูุฉ ููุณ ุงูุฏุงูุชูู:

```javascript
// ุงูุจุญุซ ุนู ุฅุณูุงุฏ ููุฌูุฏ (ุญุชู ูู ุบูุฑ ูุดุท)
static async findExisting(ticketId, userId)

// ุฅุนุงุฏุฉ ุชูุนูู ุฅุณูุงุฏ ูุญุฐูู
static async reactivate(id, updateData)
```

### 2. ุชุญุฏูุซ Controllers

#### `TicketReviewerController.js` - ุฏุงูุฉ `addReviewer`

**ุงูููุทู ุงูุฌุฏูุฏ:**
1. ุงูุชุญูู ูู ูุฌูุฏ ูุฑุงุฌุน ูุดุท (`is_active = true`)
2. ุฅุฐุง ููุฌูุฏ ููุดุท โ ุฑูุถ ุงูุทูุจ (409)
3. ุงูุจุญุซ ุนู ุณุฌู ูุญุฐูู (`is_active = false`)
4. ุฅุฐุง ููุฌุฏ ุณุฌู ูุญุฐูู โ ุฅุนุงุฏุฉ ุชูุนููู
5. ุฅุฐุง ูู ููุฌุฏ ุฃู ุณุฌู โ ุฅูุดุงุก ุณุฌู ุฌุฏูุฏ

#### `TicketAssignmentController.js` - ุฏุงูุฉ `assignUser`

ููุณ ุงูููุทู ูุทุจู ุนูู ุงูุฅุณูุงุฏ.

### 3. ุขููุฉ ุงูุนูู

```mermaid
graph TD
    A[ุทูุจ ุฅุถุงูุฉ ูุฑุงุฌุน/ูุณุชุฎุฏู] --> B{ูู ููุฌูุฏ ููุดุท?}
    B -->|ูุนู| C[ุฑูุถ: 409 ููุถุงู ุจุงููุนู]
    B -->|ูุง| D{ูู ููุฌูุฏ ูุญุฐูู?}
    D -->|ูุนู| E[ุฅุนุงุฏุฉ ุชูุนูู ุงูุณุฌู ุงููุฏูู]
    D -->|ูุง| F[ุฅูุดุงุก ุณุฌู ุฌุฏูุฏ]
    E --> G[ูุฌุญ: 201]
    F --> G
```

## ๐ ุงูุชุบููุฑุงุช ุงูุชูุตูููุฉ

### ูููุงุช ุชู ุชุนุฏูููุง

1. **`models/TicketReviewer.js`**
   - ุฅุถุงูุฉ `findExisting()` - ุงูุจุญุซ ุนู ุณุฌู ุจุบุถ ุงููุธุฑ ุนู ุญุงูุชู
   - ุฅุถุงูุฉ `reactivate()` - ุฅุนุงุฏุฉ ุชูุนูู ุณุฌู ูุญุฐูู
   - ุชุญุฏูุซ ุงูุชุนููู ุนูู `exists()` ูุชูุถูุญ ุฃูู ูุจุญุซ ุนู ุงูุณุฌูุงุช ุงููุดุทุฉ ููุท

2. **`models/TicketAssignment.js`**
   - ุฅุถุงูุฉ `findExisting()` - ุงูุจุญุซ ุนู ุณุฌู ุจุบุถ ุงููุธุฑ ุนู ุญุงูุชู
   - ุฅุถุงูุฉ `reactivate()` - ุฅุนุงุฏุฉ ุชูุนูู ุณุฌู ูุญุฐูู
   - ุชุญุฏูุซ ุงูุชุนููู ุนูู `exists()` ูุชูุถูุญ ุฃูู ูุจุญุซ ุนู ุงูุณุฌูุงุช ุงููุดุทุฉ ููุท

3. **`controllers/TicketReviewerController.js`**
   - ุชุญุฏูุซ `addReviewer()` ููุญุต ุงูุณุฌูุงุช ุงููุญุฐููุฉ ูุฅุนุงุฏุฉ ุชูุนูููุง

4. **`controllers/TicketAssignmentController.js`**
   - ุชุญุฏูุซ `assignUser()` ููุญุต ุงูุณุฌูุงุช ุงููุญุฐููุฉ ูุฅุนุงุฏุฉ ุชูุนูููุง

### ูููุงุช ุฌุฏูุฏุฉ

5. **`test-reviewer-assignment-fix.js`**
   - ุณูุฑูุจุช ุงุฎุชุจุงุฑ ุดุงูู
   - ูุฎุชุจุฑ ุฌููุน ุงูุณููุงุฑูููุงุช: ุฅุถุงูุฉุ ุญุฐูุ ุฅุนุงุฏุฉ ุฅุถุงูุฉ
   - ุชูุงุฑูุฑ ููููุฉ ููุงุถุญุฉ

6. **`REVIEWER_ASSIGNMENT_FIX.md`**
   - ูุฐุง ุงูููู - ุชูุซูู ุดุงูู ููุฅุตูุงุญ

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุชุดุบูู ุงูุงุฎุชุจุงุฑ

```bash
cd project/api
node test-reviewer-assignment-fix.js
```

### ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ

#### ูููุฑุงุฌุนูู:
1. โ ุฅุถุงูุฉ ูุฑุงุฌุน ุฌุฏูุฏ
2. โ ููุน ุฅุถุงูุฉ ูุฑุงุฌุน ููุฑุฑ (409)
3. โ ุญุฐู ุงููุฑุงุฌุน (soft delete)
4. โ ุฅุนุงุฏุฉ ุฅุถุงูุฉ ุงููุฑุงุฌุน ุจูุฌุงุญ
5. โ ุงูุชุญูู ูู ุงูุจูุงูุงุช
6. โ ุชูุธูู (hard delete)

#### ููุฅุณูุงุฏ:
1. โ ุฅุณูุงุฏ ูุณุชุฎุฏู ุฌุฏูุฏ
2. โ ููุน ุฅุณูุงุฏ ููุฑุฑ (409)
3. โ ุญุฐู ุงูุฅุณูุงุฏ (soft delete)
4. โ ุฅุนุงุฏุฉ ุฅุณูุงุฏ ุงููุณุชุฎุฏู ุจูุฌุงุญ
5. โ ุงูุชุญูู ูู ุงูุจูุงูุงุช
6. โ ุชูุธูู (hard delete)

## ๐ง ุงูุงุณุชุฎุฏุงู

### ุฅุถุงูุฉ ูุฑุงุฌุน (ูุน ุงูุญูุงูุฉ ุงูุชููุงุฆูุฉ)

```bash
curl -X POST http://localhost:3003/api/ticket-reviewers \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ticket_id": "TICKET_ID",
    "reviewer_id": "USER_ID",
    "review_notes": "ููุงุญุธุงุช ุงููุฑุงุฌุนุฉ"
  }'
```

**ุงููุชุงุฆุฌ ุงููุชููุนุฉ:**
- ุฅุฐุง ูุงู ุงููุฑุงุฌุน ุฌุฏูุฏ โ `201 Created` + "ุชู ุฅุถุงูุฉ ุงููุฑุงุฌุน ุจูุฌุงุญ"
- ุฅุฐุง ูุงู ููุฌูุฏ ููุดุท โ `409 Conflict` + "ุงููุฑุงุฌุน ููุถุงู ุจุงููุนู ููุฐู ุงูุชุฐูุฑุฉ"
- ุฅุฐุง ูุงู ูุญุฐูู ุณุงุจูุงู โ `201 Created` + "ุชู ุฅุนุงุฏุฉ ุฅุถุงูุฉ ุงููุฑุงุฌุน ุจูุฌุงุญ"

### ุฅุถุงูุฉ ุฅุณูุงุฏ (ูุน ุงูุญูุงูุฉ ุงูุชููุงุฆูุฉ)

```bash
curl -X POST http://localhost:3003/api/ticket-assignments \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ticket_id": "TICKET_ID",
    "user_id": "USER_ID",
    "role": "assignee",
    "notes": "ููุงุญุธุงุช ุงูุฅุณูุงุฏ"
  }'
```

**ุงููุชุงุฆุฌ ุงููุชููุนุฉ:**
- ุฅุฐุง ูุงู ุงูุฅุณูุงุฏ ุฌุฏูุฏ โ `201 Created` + "ุชู ุฅุณูุงุฏ ุงููุณุชุฎุฏู ุจูุฌุงุญ"
- ุฅุฐุง ูุงู ููุฌูุฏ ููุดุท โ `409 Conflict` + "ุงููุณุชุฎุฏู ููุณูุฏ ุจุงููุนู ููุฐู ุงูุชุฐูุฑุฉ"
- ุฅุฐุง ูุงู ูุญุฐูู ุณุงุจูุงู โ `201 Created` + "ุชู ุฅุนุงุฏุฉ ุฅุณูุงุฏ ุงููุณุชุฎุฏู ุจูุฌุงุญ"

## ๐ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุจููุฉ ุงูุฌุฏุงูู

#### `ticket_reviewers`
```sql
CREATE TABLE ticket_reviewers (
  id UUID PRIMARY KEY,
  ticket_id UUID REFERENCES tickets(id),
  reviewer_id UUID REFERENCES users(id),
  is_active BOOLEAN DEFAULT TRUE,
  review_status VARCHAR(50) DEFAULT 'pending',
  reviewed_at TIMESTAMPTZ,
  added_by UUID REFERENCES users(id),
  added_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(ticket_id, reviewer_id)  -- ุงูููุฏ ุงููุฑูุฏ
);
```

#### `ticket_assignments`
```sql
CREATE TABLE ticket_assignments (
  id UUID PRIMARY KEY,
  ticket_id UUID REFERENCES tickets(id),
  user_id UUID REFERENCES users(id),
  is_active BOOLEAN DEFAULT TRUE,
  role VARCHAR(50) DEFAULT 'assignee',
  assigned_by UUID REFERENCES users(id),
  assigned_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(ticket_id, user_id)  -- ุงูููุฏ ุงููุฑูุฏ
);
```

### ุงููููุฏ ุงููุฑูุฏุฉ

ุงูููุฏ `UNIQUE(ticket_id, reviewer_id)` ู `UNIQUE(ticket_id, user_id)` ูููุน:
- โ ูุฌูุฏ ููุณ ุงููุณุชุฎุฏู ููุฑุงุฌุน/ููุณูุฏ ูุดุท ูุฑุชูู
- โ ูุฌูุฏ ููุณ ุงููุณุชุฎุฏู ูุณุฌููู ูุญุฐูููู
- โ๏ธ **ุงููุดููุฉ ุงูุณุงุจูุฉ:** ูุงู ูููุน ุฅุนุงุฏุฉ ุฅุถุงูุฉ ุณุฌู ูุญุฐูู

**ุงูุญู:** ุจุฏูุงู ูู ูุญุงููุฉ ุฅุฏุฎุงู ุณุฌู ุฌุฏูุฏุ ููุนูุฏ ุชูุนูู ุงูุณุฌู ุงููุฏูู.

## ๐ฏ ุงูููุงุฆุฏ

1. **ูุง ูุฒูุฏ ูู ุฃุฎุทุงุก duplicate key** โ
2. **ุงูุญูุงุธ ุนูู ุชุงุฑูุฎ ุงูุจูุงูุงุช** - ุงูุณุฌูุงุช ุงููุฏููุฉ ูุง ุชูุญุฐู
3. **ุฃุฏุงุก ุฃูุถู** - ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุงูุณุฌูุงุช ุจุฏูุงู ูู ุฅูุดุงุก ุฌุฏูุฏุฉ
4. **ุณูุงูุฉ ุงูุจูุงูุงุช** - ุงููููุฏ ุงููุฑูุฏุฉ ุชุจูู ูุดุทุฉ
5. **ูุฑููุฉ** - ูููู ุงุณุชุฎุฏุงู hard delete ุนูุฏ ุงูุญุงุฌุฉ

## ๐ ููุงุญุธุงุช ุงูุฃูุงู

- โ ุฌููุน endpoints ูุญููุฉ ุจู JWT authentication
- โ ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุฏุฎูุฉ
- โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุจุดูู ุตุญูุญ
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ุฏูู ูุดู ุชูุงุตูู ุงููุธุงู

## ๐ ุงูุฃุฏุงุก

- **ุงูุชุญุณููุงุช:**
  - ุงุณุชุนูุงู ูุงุญุฏ ุฅุถุงูู ููุท (`findExisting`)
  - ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุงูุณุฌูุงุช ุจุฏูุงู ูู ุงูุญุฐู ูุงูุฅูุดุงุก
  - ุงุณุชุฎุฏุงู indexes ุนูู ุงูุฃุนูุฏุฉ ุงููุฑูุฏุฉ

- **ุงูุชุฃุซูุฑ:**
  - ุชุฃุฎูุฑ ุฅุถุงูู: < 5ms
  - ุชุฃุซูุฑ ุถุฆูู ุนูู ุงูุฃุฏุงุก ุงูุนุงู

## ๐ ุงููุดุฑ

### ุฎุทูุงุช ุงููุดุฑ

1. โ ุงูุชุฃูุฏ ูู ุชุญุฏูุซ ุฌููุน ุงููููุงุช
2. โ ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช
3. โ ูุฑุงุฌุนุฉ ุงูููุฏ
4. โ ูุดุฑ ุงูุชุญุฏูุซุงุช
5. โ ูุฑุงูุจุฉ ุงูุฃุฎุทุงุก

### ุงูุชุฑุงุฌุน (Rollback)

ุฅุฐุง ุญุฏุซุช ูุดุงููุ ูููู ุงูุชุฑุงุฌุน ุนู ุทุฑูู:
1. ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุณุงุจูุฉ ูู ุงููููุงุช
2. ูุง ุญุงุฌุฉ ูุชุบููุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุงูุจููุฉ ูู ุชุชุบูุฑ)

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:
1. ุชุญูู ูู ุงูู logs ูู `console.error`
2. ุดุบูู ุณูุฑูุจุช ุงูุงุฎุชุจุงุฑ ููุชุญูู
3. ุชุฃูุฏ ูู ุตุญุฉ ุงูู JWT token
4. ุชุญูู ูู ูุฌูุฏ ุงูุณุฌูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

## โจ ุงูุญุงูุฉ

- **ุงูุญุงูุฉ:** โ ููุชูู ููุฎุชุจุฑ
- **ุงูุชุงุฑูุฎ:** 2025-10-09
- **ุงูุฅุตุฏุงุฑ:** 1.0.0
- **ุงููููุงุช ุงููุชุฃุซุฑุฉ:** 4 ูููุงุช
- **ุงููููุงุช ุงูุฌุฏูุฏุฉ:** 2 ููู

---

**ุชู ุงูุงุฎุชุจุงุฑ ูุงูุชุฃูุฏ ูู ุงูุนูู ุจูุฌุงุญ! โ**
