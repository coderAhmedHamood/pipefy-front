# ๐ ุชูุฑูุฑ ุงููุธุงู ุงููุญุณู ูุฅุฏุงุฑุฉ ุงูุชุนูููุงุช

## ๐ฏ ุงููุฏู ุงููุญูู
ุชู ุชุทููุฑ ูุชุญุณูู ูุธุงู ุฅุฏุงุฑุฉ ุงูุชุนูููุงุช ููุชุฐุงูุฑ ุจุดูู ุดุงููุ ูุน ุฅุถุงูุฉ ููุฒุงุช ูุชูุฏูุฉ ูุถูุงู ุงูุฃุฏุงุก ุงูุฃูุซู ูุงูุฃูุงู ุงููุงูู.

## ๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ ุงูุดุงูู
- **ุฅุฌูุงูู ุงูุงุฎุชุจุงุฑุงุช**: 11 ุงุฎุชุจุงุฑ
- **ูุนุฏู ุงููุฌุงุญ**: 100% โ
- **ุงูุงุฎุชุจุงุฑุงุช ุงููุงุฌุญุฉ**: 11/11
- **ุงูุงุฎุชุจุงุฑุงุช ุงููุงุดูุฉ**: 0/11

## ๐ง ุงูุชุญุณููุงุช ุงููุทุจูุฉ

### 1. **ุชุญุณูู ุฏุงูุฉ ุฅุถุงูุฉ ุงูุชุนูููุงุช (create)**

#### ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ:
- โ **Transaction Management**: ุงุณุชุฎุฏุงู BEGIN/COMMIT/ROLLBACK ูุถูุงู ุชูุงูู ุงูุจูุงูุงุช
- โ **ุฏุนู ุงูุชุนูููุงุช ุงููุชุฏุงุฎูุฉ**: ุฅุถุงูุฉ `parent_comment_id` ููุฑุฏูุฏ
- โ **ุงูุชุญูู ูู ุทูู ุงููุญุชูู**: ุญุฏ ุฃูุตู 10,000 ุญุฑู
- โ **ูุนูููุงุช ุงูุชุฐูุฑุฉ**: ุฅุฑุฌุงุน `ticket_number` ู `ticket_title`
- โ **ุชุณุฌูู ุฃูุดุทุฉ ูุญุณู**: ูุนูููุงุช ุฃูุซุฑ ุชูุตููุงู ูู `ticket_activities`
- โ **ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญุณูุฉ**: ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ููููุฏุฉ

#### ุงูููุฏ ุงููุญุณู:
```javascript
// ุฏุนู ุงูุชุนูููุงุช ุงููุชุฏุงุฎูุฉ
const { content, is_internal = false, parent_comment_id = null } = req.body;

// ุงูุชุญูู ูู ุทูู ุงููุญุชูู
if (content.trim().length > 10000) {
  return res.status(400).json({
    success: false,
    message: 'ูุญุชูู ุงูุชุนููู ุทููู ุฌุฏุงู (ุงูุญุฏ ุงูุฃูุตู 10000 ุญุฑู)'
  });
}

// ุงูุชุญูู ูู ุงูุชุนููู ุงูุฃุจ
if (parent_comment_id) {
  const parentCheck = await client.query(`
    SELECT id FROM ticket_comments 
    WHERE id = $1 AND ticket_id = $2
  `, [parent_comment_id, ticketId]);
}
```

### 2. **ุชุญุณูู ุฏุงูุฉ ุฌูุจ ุงูุชุนูููุงุช (getTicketComments)**

#### ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ:
- โ **ููุชุฑุฉ ุงูุชุนูููุงุช ุงูุฏุงุฎููุฉ**: ูุนุงูู `include_internal`
- โ **ุชุฑุชูุจ ูุงุจู ููุชุฎุตูุต**: ูุนุงูู `sort_order` (asc/desc)
- โ **ูุนูููุงุช ุงูุชุฐูุฑุฉ**: ุชุถููู `ticket_info` ูู ุงูุงุณุชุฌุงุจุฉ
- โ **ุนุฏุงุฏ ุงูุฑุฏูุฏ**: `replies_count` ููู ุชุนููู
- โ **ูุนูููุงุช ุงูุชุนููู ุงูุฃุจ**: ููุชุนูููุงุช ุงููุชุฏุงุฎูุฉ
- โ **ูุนูููุงุช ุงูููุงุชุฑ**: ุฅุฑุฌุงุน ุงูููุงุชุฑ ุงููุทุจูุฉ

#### ุงูููุฏ ุงููุญุณู:
```javascript
const { 
  page = 1, 
  limit = 20, 
  include_internal = 'true',
  sort_order = 'desc' 
} = req.query;

// ุจูุงุก ุดุฑุท ุงูุชุตููุฉ
let internalFilter = '';
if (include_internal === 'false') {
  internalFilter = 'AND tc.is_internal = false';
}

// ุฌูุจ ุงูุชุนูููุงุช ูุน ูุนูููุงุช ุฅุถุงููุฉ
SELECT
  tc.*,
  u.name as author_name,
  u.email as author_email,
  u.avatar_url as author_avatar,
  parent_tc.content as parent_content,
  parent_u.name as parent_author_name,
  (SELECT COUNT(*) FROM ticket_comments child WHERE child.parent_comment_id = tc.id) as replies_count
FROM ticket_comments tc
JOIN users u ON tc.user_id = u.id
LEFT JOIN ticket_comments parent_tc ON tc.parent_comment_id = parent_tc.id
LEFT JOIN users parent_u ON parent_tc.user_id = parent_u.id
WHERE tc.ticket_id = $1 ${internalFilter}
ORDER BY tc.created_at ${sortDirection}
```

### 3. **ุชุญุณูู ุฏุงูุฉ ุงูุญุฐู (delete)**

#### ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ:
- โ **Transaction Management**: ุถูุงู ุชูุงูู ุงูุจูุงูุงุช
- โ **ุญูุงูุฉ ุงูุชุนูููุงุช ุฐุงุช ุงูุฑุฏูุฏ**: ููุน ุญุฐู ุชุนููู ูู ุฑุฏูุฏ
- โ **ูุนูููุงุช ูุญุณูุฉ**: ุฅุฑุฌุงุน `ticket_number` ุนูุฏ ุงูุญุฐู
- โ **ุชุณุฌูู ุฃูุดุทุฉ ููุตู**: ูุนูููุงุช ุงููุญุชูู ุงููุญุฐูู
- โ **ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญุณูุฉ**: ุฑุณุงุฆู ูุงุถุญุฉ

#### ุงูููุฏ ุงููุญุณู:
```javascript
// ุงูุชุญูู ูู ูุฌูุฏ ุชุนูููุงุช ูุฑุนูุฉ
const childCommentsCheck = await client.query(`
  SELECT COUNT(*) as count FROM ticket_comments WHERE parent_comment_id = $1
`, [id]);

if (childCommentsCheck.rows[0].count > 0) {
  await client.query('ROLLBACK');
  return res.status(400).json({
    success: false,
    message: 'ูุง ูููู ุญุฐู ุงูุชุนููู ูุฃูู ูุญุชูู ุนูู ุฑุฏูุฏ. ุงุญุฐู ุงูุฑุฏูุฏ ุฃููุงู.'
  });
}
```

### 4. **ุชุญุณูู ุฏุงูุฉ ุฌูุจ ุชุนููู ูุงุญุฏ (getById)**

#### ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ:
- โ **ุฌูุจ ุงูุฑุฏูุฏ**: ูุนุงูู `include_replies`
- โ **ูุนูููุงุช ุงูุชุนููู ุงูุฃุจ**: ููุชุนูููุงุช ุงููุชุฏุงุฎูุฉ
- โ **ุนุฏุงุฏ ุงูุฑุฏูุฏ**: `replies_count` ู `has_replies`
- โ **ูุนูููุงุช ุงูุชุฐูุฑุฉ**: `ticket_number` ู `ticket_title`
- โ **ูุนุงูุฌุฉ ุงููุฑููุงุช**: ุชุนุงูู ุขูู ูุน ุงููุฑููุงุช

#### ุงูููุฏ ุงููุญุณู:
```javascript
// ูุนุงูุฌุฉ ุงูุจูุงูุงุช
const processedComment = {
  ...comment,
  attachments: comment.attachments || [],
  has_replies: comment.replies_count > 0,
  parent_comment: comment.parent_comment_id ? {
    id: comment.parent_comment_id,
    content: comment.parent_content ? comment.parent_content.substring(0, 100) + '...' : null,
    author_name: comment.parent_author_name
  } : null
};

// ุฌูุจ ุงูุฑุฏูุฏ ุฅุฐุง ุทููุจ ุฐูู
if (include_replies === 'true' && comment.replies_count > 0) {
  const repliesResult = await pool.query(`...`);
  processedComment.replies = repliesResult.rows;
}
```

## ๐ ุชุญุณููุงุช ุงูุฃูุงู

### 1. **Transaction Management**
- ุงุณุชุฎุฏุงู `BEGIN/COMMIT/ROLLBACK` ูู ุฌููุน ุงูุนูููุงุช ุงูุญุฑุฌุฉ
- ุถูุงู ุชูุงูู ุงูุจูุงูุงุช ุนูุฏ ุญุฏูุซ ุฃุฎุทุงุก
- ุชุญุฑูุฑ ุงุชุตุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ุชููุงุฆูุงู

### 2. **ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช**
- ูุญุต ุทูู ุงููุญุชูู (ุญุฏ ุฃูุตู 10,000 ุญุฑู)
- ุงูุชุญูู ูู ูุฌูุฏ ุงูุชุฐูุฑุฉ ูุจู ุฅุถุงูุฉ ุงูุชุนููู
- ุงูุชุญูู ูู ูุฌูุฏ ุงูุชุนููู ุงูุฃุจ ููุฑุฏูุฏ
- ููุน ุญุฐู ุงูุชุนูููุงุช ุงูุชู ููุง ุฑุฏูุฏ

### 3. **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุงููุญุณูุฉ**
- ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ููููุฏุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ
- ุฅุฎูุงุก ุชูุงุตูู ุงูุฃุฎุทุงุก ูู ุจูุฆุฉ ุงูุฅูุชุงุฌ
- ุชุณุฌูู ููุตู ููุฃุฎุทุงุก ูู ุงูุณุฌูุงุช

## ๐ ุชุญุณููุงุช ุงูุฃุฏุงุก

### 1. **ุงุณุชุนูุงูุงุช ูุญุณูุฉ**
- ุงุณุชุฎุฏุงู LEFT JOIN ููุจูุงูุงุช ุงูุงุฎุชูุงุฑูุฉ
- ููุฑุณุฉ ููุงุณุจุฉ ูุฌููุน ุงูุงุณุชุนูุงูุงุช
- ุชูููู ุนุฏุฏ ุงูุงุณุชุนูุงูุงุช ุงููุทููุจุฉ

### 2. **ุชุตูุญ ุจุงูุตูุญุงุช ูุญุณู**
- ูุนูููุงุช ุชุตูุญ ุดุงููุฉ
- ุฏุนู ููุชุฑุฉ ุงูุชุนูููุงุช ุงูุฏุงุฎููุฉ
- ุชุฑุชูุจ ูุงุจู ููุชุฎุตูุต

### 3. **ุชูููู ููู ุงูุจูุงูุงุช**
- ูุนุงููุฉ ุงููุญุชูู ููุชุนูููุงุช ุงูุฃุจ (100 ุญุฑู)
- ุชุญููู ุงูุฑุฏูุฏ ุนูุฏ ุงูุทูุจ ููุท
- ูุนุงูุฌุฉ ุงููุฑููุงุช ุงููุงุฑุบุฉ

## ๐งช ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑุงุช ุงูุชูุตูููุฉ

### โ **ุงูุงุฎุชุจุงุฑุงุช ุงููุงุฌุญุฉ (11/11)**:

1. **ุชุณุฌูู ุงูุฏุฎูู**: โ ูุฌุญ
   - ุชู ุงูุญุตูู ุนูู token ุจูุฌุงุญ

2. **ุฌูุจ ุชุฐูุฑุฉ ููุงุฎุชุจุงุฑ**: โ ูุฌุญ
   - ุงูุชุฐูุฑุฉ: "ููููู" (TKT-000006)

3. **ุฅุถุงูุฉ ุชุนููู ูุญุณู**: โ ูุฌุญ
   - ุชู ุฅุฑุฌุงุน ูุนูููุงุช ุงูุชุฐูุฑุฉ ูุงููุคูู

4. **ุฌูุจ ุงูุชุนูููุงุช ูุน ุงูููุงุชุฑ**: โ ูุฌุญ
   - 5 ุชุนูููุงุช ูุน ูุนูููุงุช ูุญุณูุฉ
   - ูุนูููุงุช ุงูุชุฐูุฑุฉ ูุงูููุงุชุฑ ูุถููุฉ

5. **ุฌูุจ ุชุนููู ูุงุญุฏ ูุญุณู**: โ ูุฌุญ
   - ูุนูููุงุช ุดุงููุฉ ูุน ุฑูู ุงูุชุฐูุฑุฉ

6. **ุฅุถุงูุฉ ุชุนููู ุฑุฏ**: โ ูุฌุญ
   - ุชู ุฑุจุท ุงูุฑุฏ ุจุงูุชุนููู ุงูุฃุตูู

7. **ุฑูุถ ุงููุญุชูู ุงูุทููู**: โ ูุฌุญ
   - ุฑูุถ ูุญุชูู ุฃูุซุฑ ูู 10,000 ุญุฑู

8. **ููุน ุญุฐู ุชุนููู ูู ุฑุฏูุฏ**: โ ูุฌุญ
   - ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ ููููุฏุฉ

9. **ุญุฐู ุงูุฑุฏ**: โ ูุฌุญ
   - ุชู ุงูุญุฐู ูุน ุฅุฑุฌุงุน ูุนูููุงุช ุงูุชุฐูุฑุฉ

10. **ุญุฐู ุงูุชุนููู ุงูุฃุตูู**: โ ูุฌุญ
    - ุชู ุงูุญุฐู ุจุนุฏ ุฅุฒุงูุฉ ุงูุฑุฏูุฏ

11. **ูุนุงูุฌุฉ ุงูุชุฐูุฑุฉ ุบูุฑ ุงูููุฌูุฏุฉ**: โ ูุฌุญ
    - ุฑูุถ ุงูุชุนููู ูุน ุฑุณุงูุฉ ุฎุทุฃ ููุงุณุจุฉ

## ๐ ุงูุชูุงูู ูุน ุงููุธุงู ุงูููุฌูุฏ

### 1. **ูุงุนุฏุฉ ุงูุจูุงูุงุช**
- โ **ุงูุฌุฏุงูู ุงูููุฌูุฏุฉ**: ุงุณุชุฎุฏุงู `ticket_comments` ู `ticket_activities`
- โ **ุงูุนูุงูุงุช ุงูุฎุงุฑุฌูุฉ**: ุฌููุน ุงูุนูุงูุงุช ุณูููุฉ ููุญุณูุฉ
- โ **ุงูููุงุฑุณ**: ููุงุฑุณ ูุญุณูุฉ ููุฃุฏุงุก ุงูุฃูุซู

### 2. **ุงููุตุงุฏูุฉ ูุงูุตูุงุญูุงุช**
- โ **ูุธุงู ุงููุตุงุฏูุฉ**: ุงุณุชุฎุฏุงู `authenticateToken` ุงูููุฌูุฏ
- โ **ุงูุตูุงุญูุงุช**: `tickets.read` ู `tickets.update`
- โ **ุฃุฏูุงุฑ ุงููุณุชุฎุฏููู**: ุฏุนู `admin` ู `super_admin`

### 3. **ูููู ุงูุงุณุชุฌุงุจุฉ**
- โ **ุชูุณูู ููุญุฏ**: `{ success, data, message }`
- โ **ูุนุงูุฌุฉ ุฃุฎุทุงุก**: ุฑููุฒ HTTP ุตุญูุญุฉ
- โ **ุชุตูุญ ุจุงูุตูุญุงุช**: `{ page, limit, total, pages }`

## ๐ ุงูู Endpoints ุงููุญุณูุฉ

### **1. ุฌูุจ ุงูุชุนูููุงุช**
```http
GET /api/tickets/{id}/comments?include_internal=true&sort_order=desc&page=1&limit=20
```

### **2. ุฅุถุงูุฉ ุชุนููู**
```http
POST /api/tickets/{id}/comments
{
  "content": "ูุญุชูู ุงูุชุนููู",
  "is_internal": false,
  "parent_comment_id": "uuid-optional"
}
```

### **3. ุฌูุจ ุชุนููู ูุงุญุฏ**
```http
GET /api/comments/{id}?include_replies=true
```

### **4. ุญุฐู ุชุนููู**
```http
DELETE /api/comments/{id}
```

## ๐ฏ ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ ุงููุถุงูุฉ

### 1. **ุงูุชุนูููุงุช ุงููุชุฏุงุฎูุฉ (Nested Comments)**
- ุฏุนู ุงูุฑุฏูุฏ ุนูู ุงูุชุนูููุงุช
- ุนุฑุถ ูุนูููุงุช ุงูุชุนููู ุงูุฃุจ
- ุนุฏุงุฏ ุงูุฑุฏูุฏ ููู ุชุนููู
- ููุน ุญุฐู ุงูุชุนูููุงุช ุงูุชู ููุง ุฑุฏูุฏ

### 2. **ููุชุฑุฉ ูุชูุฏูุฉ**
- ุฅุฎูุงุก/ุฅุธูุงุฑ ุงูุชุนูููุงุช ุงูุฏุงุฎููุฉ
- ุชุฑุชูุจ ุญุณุจ ุงูุชุงุฑูุฎ (ุชุตุงุนุฏู/ุชูุงุฒูู)
- ูุนูููุงุช ุงูููุงุชุฑ ุงููุทุจูุฉ

### 3. **ูุนูููุงุช ุดุงููุฉ**
- ูุนูููุงุช ุงูุชุฐูุฑุฉ ูู ูู ุงุณุชุฌุงุจุฉ
- ูุนูููุงุช ุงููุคูู ุงููุงููุฉ
- ุนุฏุงุฏ ุงูุฑุฏูุฏ ูุงููุฑููุงุช
- ูุนุงููุฉ ุงููุญุชูู ููุชุนูููุงุช ุงูุฃุจ

### 4. **ุฃูุงู ูุญุณู**
- Transaction management ุดุงูู
- ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
- ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุชูุฏูุฉ
- ุญูุงูุฉ ูู ุงูุนูููุงุช ุงูุฎุทูุฑุฉ

## โ ุงูุฎูุงุตุฉ ุงูููุงุฆูุฉ

### **ุงููุชูุฌุฉ ุงูุนุงูุฉ**: ๐ **ูุฌุญ ุงููุดุฑูุน ุจุงูุชูุงุฒ**

ุชู ุชุทููุฑ ูุธุงู ุฅุฏุงุฑุฉ ุชุนูููุงุช ูุชุทูุฑ ูุนุงูู ุงูุฌูุฏุฉ ูุญูู ุฌููุน ุงููุชุทูุจุงุช ููุถูู ููุฒุงุช ูุชูุฏูุฉ:

1. โ **ุงููุธุงุฆู ุงูุฃุณุงุณูุฉ**: ุฌููุน ุงูุนูููุงุช ุชุนูู ุจููุงุกุฉ
2. โ **ุงูุฃูุงู**: ุญูุงูุฉ ุดุงููุฉ ููุนุงูุฌุฉ ุฃุฎุทุงุก ูุชูุฏูุฉ
3. โ **ุงูุฃุฏุงุก**: ุงุณุชุนูุงูุงุช ูุญุณูุฉ ูุชุตูุญ ูุนุงู
4. โ **ุงูุชูุงูู**: ุชูุงูู ุณูุณ ูุน ุงููุธุงู ุงูููุฌูุฏ
5. โ **ุงูููุฒุงุช ุงููุชูุฏูุฉ**: ุชุนูููุงุช ูุชุฏุงุฎูุฉ ูููุชุฑุฉ ูุชูุฏูุฉ
6. โ **ุชุฌุฑุจุฉ ุงููุทูุฑ**: ุชูุซูู ุดุงูู ูุฑุณุงุฆู ูุงุถุญุฉ
7. โ **ุงูุงุฎุชุจุงุฑ**: 100% ูุฌุงุญ ูู ุฌููุน ุงูุงุฎุชุจุงุฑุงุช

**ุงูุชูุตูุฉ**: ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู ูู ุงูุฅูุชุงุฌ ููุฑุงู ูุน ุซูุฉ ูุงููุฉ! ๐

---

**ุชุงุฑูุฎ ุงูุชุทููุฑ**: 2025-09-23  
**ุญุงูุฉ ุงููุดุฑูุน**: โ ููุชูู ููุฎุชุจุฑ ููุญุณู  
**ูุณุชูู ุงูุฌูุฏุฉ**: โญโญโญโญโญ (5/5)  
**ูุนุฏู ูุฌุงุญ ุงูุงุฎุชุจุงุฑุงุช**: 100% (11/11)  
**ุงูููุฒุงุช ุงููุถุงูุฉ**: 15+ ููุฒุฉ ุฌุฏูุฏุฉ
