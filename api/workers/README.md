# ๐ Worker ููุชุฐุงูุฑ ุงููุชูุฑุฑุฉ

## ูุธุฑุฉ ุนุงูุฉ

Worker ูุณุชูู ูุนูู ูู ุงูุฎูููุฉ ููุญุต ุงูุชุฐุงูุฑ ุงููุชูุฑุฑุฉ ุงููุณุชุญูุฉ ููุชูููุฐ ูุชูููุฐูุง ุชููุงุฆูุงู. ูุนูู ุจุดูู ูููุตู ุชูุงูุงู ุนู ุงูุฎุงุฏู ุงูุฑุฆูุณู.

## ุงููุฒุงูุง

โ **ูุณุชูู ุชูุงูุงู** - ูุนูู ูู Process ูููุตู  
โ **ุฃุฏุงุก ุนุงูู** - ูุญุต ุณุฑูุน ูู ุฏูููุฉ ุจุฏูู ุชูุงููู ุนุงููุฉ  
โ **ุจุณูุท ูุบูุฑ ูุนูุฏ** - ูุง ูุชุทูุจ Redis ุฃู MongoDB  
โ **ุขูู** - ูุณุชุฎุฏู Transactions ูุถูุงู ุชูุงูู ุงูุจูุงูุงุช  
โ **ูุฑู** - ูููู ุชุฎุตูุต ูุชุฑุฉ ุงููุญุต  

## ุงููููุงุช

- `workers/recurring-tickets-worker.js` - ุงูููู ุงูุฑุฆูุณู ููู Worker
- `services/RecurringExecutionService.js` - ุฎุฏูุฉ ุชูููุฐ ููุงุนุฏ ุงูุชูุฑุงุฑ

## ููููุฉ ุงูุชุดุบูู

### 1. ุงูุชุดุบูู ุงูุนุงุฏู

```bash
npm run worker:recurring
```

### 2. ุงูุชุดุบูู ูู ูุถุน ุงูุชุทููุฑ (ูุน ุฅุนุงุฏุฉ ุงูุชุดุบูู ุงูุชููุงุฆู)

```bash
npm run worker:recurring:dev
```

### 3. ุงูุชุดุบูู ุงููุฏูู

```bash
node workers/recurring-tickets-worker.js
```

## ุงูุชูููู

ูููู ุชุฎุตูุต ูุชุฑุฉ ุงููุญุต ุนุจุฑ ูุชุบูุฑ ุงูุจูุฆุฉ:

```env
RECURRING_WORKER_INTERVAL=60000  # ุจุงููููู ุซุงููุฉ (ุงูุชุฑุงุถู: 60000 = 60 ุซุงููุฉ)
```

## ุขููุฉ ุงูุนูู

1. **ุงููุญุต ุงูุฏูุฑู**: ูู ุฏูููุฉ (ุฃู ุญุณุจ ุงูุชูููู)ุ ููุญุต Worker ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุจุญุซ ุนู ููุงุนุฏ ุงูุชูุฑุงุฑ ุงููุณุชุญูุฉ
2. **ูุนุงููุฑ ุงูุงุณุชุญูุงู**:
   - `is_active = true`
   - `next_execution <= NOW()`
   - ูู ุชุตู ููุญุฏ ุงูุฃูุตู ูู ุงูุชูููุฐุงุช (`execution_count < max_executions`)
3. **ุงูุชูููุฐ**: ููู ูุงุนุฏุฉ ูุณุชุญูุฉ:
   - ุฅูุดุงุก ุชุฐูุฑุฉ ุฌุฏูุฏุฉ ูู ุงููุงูุจ
   - ุฅุณูุงุฏ ุงููุณุชุฎุฏู (ุฅู ูุฌุฏ)
   - ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุชูุฑุงุฑ (ุฒูุงุฏุฉ ุงูุนุฏุงุฏุ ุญุณุงุจ `next_execution` ุงูุชุงูู)
   - ุชุนุทูู ุงููุงุนุฏุฉ ุฅุฐุง ูุตูุช ููุญุฏ ุงูุฃูุตู

## ุงูุฅุญุตุงุฆูุงุช

Worker ูุนุฑุถ ุฅุญุตุงุฆูุงุช ูู 5 ุฏูุงุฆู:
- ุฅุฌูุงูู ุงููุญูุตุงุช
- ุฅุฌูุงูู ุงูุชูููุฐุงุช ุงููุงุฌุญุฉ
- ุฅุฌูุงูู ุงูุฃุฎุทุงุก
- ุขุฎุฑ ูุญุต ูุขุฎุฑ ุชูููุฐ

## ุฅููุงู Worker

ุงุถุบุท `Ctrl+C` ูุฅููุงู Worker ุจุดูู ุขูู.

## ููุงุญุธุงุช ูุงูุฉ

โ๏ธ **ูุง ุชูู ุจุชุดุบูู ุฃูุซุฑ ูู Worker ูุงุญุฏ ูู ููุณ ุงูููุช** - ูุฏ ูุคุฏู ุฐูู ุฅูู ุชูููุฐ ูุฒุฏูุฌ ููููุงุนุฏ.

โ๏ธ **ุชุฃูุฏ ูู ุฃู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุชุตูุฉ** ูุจู ุชุดุบูู Worker.

## ุฃูุซูุฉ ุนูู ุงูุงุณุชุฎุฏุงู ูู Production

### ุงุณุชุฎุฏุงู PM2

```bash
pm2 start workers/recurring-tickets-worker.js --name recurring-worker
pm2 save
pm2 startup
```

### ุงุณุชุฎุฏุงู systemd (Linux)

ุฅูุดุงุก ููู `/etc/systemd/system/recurring-worker.service`:

```ini
[Unit]
Description=Recurring Tickets Worker
After=network.target postgresql.service

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/api
ExecStart=/usr/bin/node workers/recurring-tickets-worker.js
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

ุซู:
```bash
sudo systemctl enable recurring-worker
sudo systemctl start recurring-worker
```

## ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

ุฅุฐุง ูู ูุชู ุชูููุฐ ุงูููุงุนุฏ:
1. ุชุฃูุฏ ูู ุฃู Worker ูุนูู: ุงุจุญุซ ุนู ุฑุณุงุฆู "๐ ุชู ุงูุนุซูุฑ ุนูู..."
2. ุชุญูู ูู ุฃู ุงูููุงุนุฏ ูุดุทุฉ (`is_active = true`)
3. ุชุญูู ูู ุฃู `next_execution` ูู ุงููุงุถู
4. ุฑุงุฌุน ุณุฌูุงุช ุงูุฃุฎุทุงุก ูู Console

## ุงูุฏุนู

ูู ุญุงูุฉ ูุฌูุฏ ูุดุงููุ ุฑุงุฌุน:
- ุณุฌูุงุช Worker ูู Console
- ุฌุฏูู `recurring_rules` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุฌุฏูู `tickets` ููุชุญูู ูู ุงูุชุฐุงูุฑ ุงููููุดุฃุฉ

