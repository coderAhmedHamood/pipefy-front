# ๐ ุชูุซูู ูุธุงู ููู ุงูุชุฐุงูุฑ ุจูู ุงูุนูููุงุช

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅูุดุงุก endpoint ุฌุฏูุฏ ูุณูุญ ุจููู ุงูุชุฐุงูุฑ ูู ุนูููุฉ ุฅูู ุนูููุฉ ุฃุฎุฑู ูุน ุชุญุฏูุซ ุงููุฑุญูุฉ ุชููุงุฆูุงู ุฅูู ุงููุฑุญูุฉ ุงูุฃูููุฉ ูู ุงูุนูููุฉ ุงููุณุชูุฏูุฉ.

---

## ๐ฏ ุงูููุฒุงุช ุงูุฑุฆูุณูุฉ

### โ ุงููุธุงุฆู ุงููุทุจูุฉ

1. **ููู ุงูุชุฐูุฑุฉ ุจูู ุงูุนูููุงุช**
   - ุชุบููุฑ `process_id` ููุชุฐูุฑุฉ
   - ุชุญุฏูุซ `current_stage_id` ุชููุงุฆูุงู

2. **ุงูุชุดุงู ุงููุฑุญูุฉ ุงูุฃูููุฉ**
   - ุงูุจุญุซ ุนู ุงููุฑุญูุฉ ุงูุชู `is_initial = true`
   - ุฅุฐุง ูู ุชูุฌุฏุ ูุชู ุงุฎุชูุงุฑ ุงููุฑุญูุฉ ุฐุงุช ุฃูู `order_index`

3. **ุชุนููู ุชููุงุฆู**
   - ุฅูุดุงุก ุชุนููู ููุถุญ ุนูููุฉ ุงูููู
   - ูุญุชูู ุนูู: ุงุณู ุงููุณุชุฎุฏูุ ุงูุนูููุฉ ุงูุณุงุจูุฉ ูุงูุฌุฏูุฏุฉุ ุงููุฑุญูุฉ ุงูุณุงุจูุฉ ูุงูุฌุฏูุฏุฉ
   - ุชุตููู ุฌููู ูุน ุฑููุฒ ุชุนุจูุฑูุฉ ๐๐ฆ๐ฏ๐

4. **ุชุณุฌูู ุงููุดุงุท**
   - ุญูุธ ุณุฌู ูู `ticket_activities`
   - ุชุชุจุน ูุงูู ูุนูููุฉ ุงูููู

5. **ูุนุงููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช**
   - ุงุณุชุฎุฏุงู Transactions ูุถูุงู ุณูุงูุฉ ุงูุจูุงูุงุช
   - Rollback ุชููุงุฆู ูู ุญุงูุฉ ุญุฏูุซ ุฎุทุฃ

---

## ๐ API Endpoint

### **POST** `/api/tickets/{id}/move-to-process`

#### ุงููุนุงููุงุช (Parameters)

| ุงููุนุงูู | ุงูููุน | ูุทููุจ | ุงููููุน | ุงููุตู |
|---------|------|-------|--------|-------|
| `id` | UUID | โ ูุนู | Path | ูุนุฑู ุงูุชุฐูุฑุฉ ุงููุฑุงุฏ ููููุง |
| `target_process_id` | UUID | โ ูุนู | Body | ูุนุฑู ุงูุนูููุฉ ุงููุณุชูุฏูุฉ |

#### Headers ุงููุทููุจุฉ

```http
Authorization: Bearer {token}
Content-Type: application/json
```

#### ุงูุตูุงุญูุงุช ุงููุทููุจุฉ

- `tickets.update`

---

## ๐ ุฃูุซูุฉ ุงูุงุณุชุฎุฏุงู

### ูุซุงู 1: ููู ุชุฐูุฑุฉ ุฅูู ุนูููุฉ ุฌุฏูุฏุฉ

**Request:**

```http
POST /api/tickets/7a6981d3-5683-46cf-9ca1-d1f06bf8a154/move-to-process
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "target_process_id": "d6f7574c-d937-4e55-8cb1-0b19269e6061"
}
```

**Response (200 OK):**

```json
{
  "success": true,
  "message": "ุชู ููู ุงูุชุฐูุฑุฉ ุจูู ุงูุนูููุงุช ุจูุฌุงุญ",
  "data": {
    "ticket": {
      "id": "7a6981d3-5683-46cf-9ca1-d1f06bf8a154",
      "ticket_number": "ุนูู-000004-1759945578034-68",
      "title": "ููู",
      "description": "ูุฎู",
      "process_id": "d6f7574c-d937-4e55-8cb1-0b19269e6061",
      "current_stage_id": "db634909-72c7-4445-930e-2e345ab49421",
      "process_name": "ุนูููุฉ ุฌุฏูุฏุฉ ุงุตุฏุงุฑ ุซุงูู",
      "stage_name": "ูุฑุญูุฉ ุฌุฏูุฏุฉ",
      "stage_color": "#6B7280",
      "priority": "urgent",
      "status": "active",
      "created_at": "2025-10-08T17:46:18.030Z",
      "updated_at": "2025-10-10T00:30:00.000Z"
    },
    "movement_details": {
      "from_process": {
        "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
        "name": "ุนูููุฉ ุงูุฏุนู ุงูููู"
      },
      "to_process": {
        "id": "d6f7574c-d937-4e55-8cb1-0b19269e6061",
        "name": "ุนูููุฉ ุฌุฏูุฏุฉ ุงุตุฏุงุฑ ุซุงูู"
      },
      "from_stage": {
        "id": "old-stage-id",
        "name": "ููุฏ ุงููุฑุงุฌุนุฉ"
      },
      "to_stage": {
        "id": "db634909-72c7-4445-930e-2e345ab49421",
        "name": "ูุฑุญูุฉ ุฌุฏูุฏุฉ",
        "color": "#6B7280",
        "order_index": 1
      },
      "moved_by": {
        "id": "588be31f-7130-40f2-92c9-34da41a20142",
        "name": "ูุฏูุฑ ุงููุธุงู ุงูุนุงู"
      },
      "moved_at": "2025-10-10T00:30:00.000Z"
    }
  }
}
```

---

## โ ุฑุณุงุฆู ุงูุฎุทุฃ

### 400 Bad Request

#### 1. ูุนุฑู ุงูุนูููุฉ ุงููุณุชูุฏูุฉ ูุทููุจ

```json
{
  "success": false,
  "message": "ูุนุฑู ุงูุนูููุฉ ุงููุณุชูุฏูุฉ (target_process_id) ูุทููุจ"
}
```

#### 2. ุงูุชุฐูุฑุฉ ููุฌูุฏุฉ ุจุงููุนู ูู ูุฐู ุงูุนูููุฉ

```json
{
  "success": false,
  "message": "ุงูุชุฐูุฑุฉ ููุฌูุฏุฉ ุจุงููุนู ูู ูุฐู ุงูุนูููุฉ"
}
```

#### 3. ุงูุนูููุฉ ุงููุณุชูุฏูุฉ ูุง ุชุญุชูู ุนูู ูุฑุงุญู

```json
{
  "success": false,
  "message": "ุงูุนูููุฉ ุงููุณุชูุฏูุฉ ูุง ุชุญุชูู ุนูู ุฃู ูุฑุงุญู"
}
```

### 404 Not Found

#### 1. ุงูุชุฐูุฑุฉ ุบูุฑ ููุฌูุฏุฉ

```json
{
  "success": false,
  "message": "ุงูุชุฐูุฑุฉ ุบูุฑ ููุฌูุฏุฉ"
}
```

#### 2. ุงูุนูููุฉ ุงููุณุชูุฏูุฉ ุบูุฑ ููุฌูุฏุฉ

```json
{
  "success": false,
  "message": "ุงูุนูููุฉ ุงููุณุชูุฏูุฉ ุบูุฑ ููุฌูุฏุฉ"
}
```

### 401 Unauthorized

```json
{
  "success": false,
  "message": "ุบูุฑ ูุตุฑุญ"
}
```

### 403 Forbidden

```json
{
  "success": false,
  "message": "ููุณ ูุฏูู ุตูุงุญูุฉ ูุชุญุฏูุซ ุงูุชุฐุงูุฑ"
}
```

---

## ๐ ุขููุฉ ุงูุนูู

### 1. ุงูุชุญูู ูู ุงูุจูุงูุงุช
```
โ ุงูุชุญูู ูู ูุฌูุฏ target_process_id
โ ุงูุชุญูู ูู ูุฌูุฏ ุงูุชุฐูุฑุฉ
โ ุงูุชุญูู ูู ุฃู ุงูุนูููุฉ ุงููุณุชูุฏูุฉ ูุฎุชููุฉ
โ ุงูุชุญูู ูู ูุฌูุฏ ุงูุนูููุฉ ุงููุณุชูุฏูุฉ
```

### 2. ุงูุชุดุงู ุงููุฑุญูุฉ ุงูุฃูููุฉ
```sql
-- ุงูุจุญุซ ุนู ุงููุฑุญูุฉ ุงูุฃูููุฉ
SELECT id, name, color, order_index
FROM stages
WHERE process_id = $1 AND is_initial = true
ORDER BY order_index ASC, priority ASC
LIMIT 1

-- ุฅุฐุง ูู ุชูุฌุฏุ ุงูุจุญุซ ุนู ุฃูู ูุฑุญูุฉ
SELECT id, name, color, order_index
FROM stages
WHERE process_id = $1
ORDER BY order_index ASC, priority ASC
LIMIT 1
```

### 3. ุชุญุฏูุซ ุงูุชุฐูุฑุฉ
```sql
UPDATE tickets
SET 
  process_id = $1,
  current_stage_id = $2,
  updated_at = NOW()
WHERE id = $3
```

### 4. ุฅูุดุงุก ุงูุชุนููู ุงูุชููุงุฆู
```
๐ ุชู ููู ุงูุชุฐูุฑุฉ ุจูู ุงูุนูููุงุช ุจูุงุณุทุฉ: [ุงุณู ุงููุณุชุฎุฏู]
๐ฆ ูู ุนูููุฉ: "[ุงุณู ุงูุนูููุฉ ุงูุณุงุจูุฉ]"
๐ฏ ุฅูู ุนูููุฉ: "[ุงุณู ุงูุนูููุฉ ุงูุฌุฏูุฏุฉ]"
๐ ูู ูุฑุญูุฉ: "[ุงุณู ุงููุฑุญูุฉ ุงูุณุงุจูุฉ]"
๐ฏ ุฅูู ูุฑุญูุฉ: "[ุงุณู ุงููุฑุญูุฉ ุงูุฌุฏูุฏุฉ]"
```

### 5. ุชุณุฌูู ุงููุดุงุท
```sql
INSERT INTO ticket_activities (
  ticket_id, user_id, action, description, 
  old_value, new_value, created_at
)
VALUES (...)
```

---

## ๐ ุงููููุงุช ุงููุชุฃุซุฑุฉ

### 1. Controller
**ุงูููู:** `controllers/TicketController.js`

**ุงูุฏุงูุฉ ุงููุถุงูุฉ:** `moveToProcess(req, res)`

**ุงููุธุงุฆู:**
- ุงูุชุญูู ูู ุงูุจูุงูุงุช
- ุงูุชุดุงู ุงููุฑุญูุฉ ุงูุฃูููุฉ
- ุชุญุฏูุซ ุงูุชุฐูุฑุฉ
- ุฅูุดุงุก ุงูุชุนููู ุงูุชููุงุฆู
- ุชุณุฌูู ุงููุดุงุท

### 2. Routes
**ุงูููู:** `routes/tickets.js`

**ุงููุณุงุฑ ุงููุถุงู:**
```javascript
router.post(
  '/:id/move-to-process', 
  authenticateToken, 
  requirePermissions(['tickets.update']), 
  TicketController.moveToProcess
);
```

**ุชูุซูู Swagger:** โ ููุชูู

### 3. ููู ุงูุงุฎุชุจุงุฑ
**ุงูููู:** `test-move-ticket-to-process.js`

**ุงููุธุงุฆู:**
- ุชุณุฌูู ุงูุฏุฎูู
- ุฌูุจ ุงูุนูููุงุช
- ุฌูุจ ุงููุฑุงุญู
- ุฌูุจ ุงูุชุฐุงูุฑ
- ููู ุงูุชุฐูุฑุฉ
- ุฌูุจ ุงูุชุนูููุงุช ููุชุญูู

---

## ๐งช ููููุฉ ุงูุงุฎุชุจุงุฑ

### 1. ุชุดุบูู ููู ุงูุงุฎุชุจุงุฑ

```bash
node test-move-ticket-to-process.js
```

### 2. ุงูุงุฎุชุจุงุฑ ุงููุฏูู ุจุงุณุชุฎุฏุงู cURL

```bash
# ุชุณุฌูู ุงูุฏุฎูู
curl -X POST http://localhost:3004/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@example.com","password":"admin123"}'

# ููู ุงูุชุฐูุฑุฉ
curl -X POST http://localhost:3004/api/tickets/{ticket_id}/move-to-process \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"target_process_id":"{process_id}"}'
```

### 3. ุงูุงุฎุชุจุงุฑ ุจุงุณุชุฎุฏุงู Postman

1. **ุชุณุฌูู ุงูุฏุฎูู:**
   - Method: POST
   - URL: `http://localhost:3004/api/auth/login`
   - Body: `{"email":"admin@example.com","password":"admin123"}`

2. **ููู ุงูุชุฐูุฑุฉ:**
   - Method: POST
   - URL: `http://localhost:3004/api/tickets/{ticket_id}/move-to-process`
   - Headers: `Authorization: Bearer {token}`
   - Body: `{"target_process_id":"{process_id}"}`

---

## ๐ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุงูุฌุฏุงูู ุงููุชุฃุซุฑุฉ

#### 1. `tickets`
```sql
-- ุงูุญููู ุงููุญุฏุซุฉ
process_id        -- ูุชู ุชุญุฏูุซู ููุนูููุฉ ุงูุฌุฏูุฏุฉ
current_stage_id  -- ูุชู ุชุญุฏูุซู ูููุฑุญูุฉ ุงูุฃูููุฉ
updated_at        -- ูุชู ุชุญุฏูุซู ุชููุงุฆูุงู
```

#### 2. `ticket_comments`
```sql
-- ูุชู ุฅุถุงูุฉ ุชุนููู ุฌุฏูุฏ
INSERT INTO ticket_comments (
  ticket_id,
  user_id,
  content,
  is_internal,
  created_at
)
```

#### 3. `ticket_activities`
```sql
-- ูุชู ุฅุถุงูุฉ ุณุฌู ูุดุงุท
INSERT INTO ticket_activities (
  ticket_id,
  user_id,
  action,           -- 'moved_to_process'
  description,
  old_value,        -- JSON: {process_id, stage_id}
  new_value,        -- JSON: {process_id, stage_id}
  created_at
)
```

---

## ๐ ุงูุฃูุงู ูุงูุตูุงุญูุงุช

### ุงููุตุงุฏูุฉ (Authentication)
- ูุชุทูุจ token ุตุงูุญ ูู header `Authorization`
- ูุชู ุงูุชุญูู ุจุงุณุชุฎุฏุงู middleware `authenticateToken`

### ุงูุชุฑุฎูุต (Authorization)
- ูุชุทูุจ ุตูุงุญูุฉ `tickets.update`
- ูุชู ุงูุชุญูู ุจุงุณุชุฎุฏุงู middleware `requirePermissions`

### ุงูุชุญูู ูู ุงูุจูุงูุงุช
- โ ุงูุชุญูู ูู ุตุญุฉ UUID
- โ ุงูุชุญูู ูู ูุฌูุฏ ุงูุณุฌูุงุช
- โ ููุน ุงูููู ุฅูู ููุณ ุงูุนูููุฉ
- โ ุงูุชุญูู ูู ูุฌูุฏ ูุฑุงุญู ูู ุงูุนูููุฉ ุงููุณุชูุฏูุฉ

---

## ๐จ ุงูุชุนููู ุงูุชููุงุฆู

### ุงูุชูุณูู

```
๐ ุชู ููู ุงูุชุฐูุฑุฉ ุจูู ุงูุนูููุงุช ุจูุงุณุทุฉ: [ุงุณู ุงููุณุชุฎุฏู]
๐ฆ ูู ุนูููุฉ: "[ุงุณู ุงูุนูููุฉ ุงูุณุงุจูุฉ]"
๐ฏ ุฅูู ุนูููุฉ: "[ุงุณู ุงูุนูููุฉ ุงูุฌุฏูุฏุฉ]"
๐ ูู ูุฑุญูุฉ: "[ุงุณู ุงููุฑุญูุฉ ุงูุณุงุจูุฉ]"
๐ฏ ุฅูู ูุฑุญูุฉ: "[ุงุณู ุงููุฑุญูุฉ ุงูุฌุฏูุฏุฉ]"
```

### ุงูุฎุตุงุฆุต
- **ุบูุฑ ุฏุงุฎูู:** `is_internal = false` (ูุฑุฆู ูุฌููุน ุงููุณุชุฎุฏููู)
- **ุชููุงุฆู:** ูุชู ุฅูุดุงุคู ุชููุงุฆูุงู ุนูุฏ ุงูููู
- **ูุนูููุงุชู:** ูุญุชูู ุนูู ุฌููุน ุงูุชูุงุตูู ุงููููุฉ

---

## ๐ ุญุงูุงุช ุงูุงุณุชุฎุฏุงู

### 1. ููู ุชุฐูุฑุฉ ูู ูุณู ุฅูู ุขุฎุฑ
```
ูุซุงู: ููู ุชุฐูุฑุฉ ูู "ุงูุฏุนู ุงูููู" ุฅูู "ุงูุชุทููุฑ"
```

### 2. ุฅุนุงุฏุฉ ุชุตููู ุงูุชุฐุงูุฑ
```
ูุซุงู: ููู ุชุฐูุฑุฉ ูู "ุทูุจุงุช ุงูููุฒุงุช" ุฅูู "ุฅุตูุงุญ ุงูุฃุฎุทุงุก"
```

### 3. ุฅุนุงุฏุฉ ุชูุฒูุน ุงูุนูู
```
ูุซุงู: ููู ุชุฐุงูุฑ ูู ุนูููุฉ ูุฏููุฉ ุฅูู ุนูููุฉ ุฌุฏูุฏุฉ
```

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **ุงููุฑุญูุฉ ุงูุฃูููุฉ:**
   - ูุชู ุงูุจุญุซ ุนู ุงููุฑุญูุฉ ุงูุชู `is_initial = true`
   - ุฅุฐุง ูู ุชูุฌุฏุ ูุชู ุงุฎุชูุงุฑ ุงููุฑุญูุฉ ุฐุงุช ุฃูู `order_index`
   - ุฅุฐุง ูู ุชูุฌุฏ ุฃู ูุฑุงุญูุ ูุชู ุฅุฑุฌุงุน ุฎุทุฃ 400

2. **ุงูุชุนููู ุงูุชููุงุฆู:**
   - ูุชู ุฅูุดุงุคู ุฏุงุฆูุงู ุนูุฏ ุงูููู
   - ุบูุฑ ูุงุจู ููุญุฐู (ูุฑุชุจุท ุจุงูุชุฐูุฑุฉ)
   - ูุญุชูู ุนูู ุฌููุน ุงูุชูุงุตูู

3. **ุณุฌู ุงููุดุงุท:**
   - ูุชู ุญูุธู ูู `ticket_activities`
   - ูุญุชูู ุนูู ุงูููู ุงููุฏููุฉ ูุงูุฌุฏูุฏุฉ ุจุตูุบุฉ JSON
   - ูููุฏ ููุชุฏููู ูุงููุฑุงุฌุนุฉ

4. **ุงููุนุงููุงุช (Transactions):**
   - ุฌููุน ุงูุนูููุงุช ุชุชู ุฏุงุฎู transaction
   - ูู ุญุงูุฉ ุญุฏูุซ ุฎุทุฃุ ูุชู Rollback ุชููุงุฆู
   - ูุถูู ุณูุงูุฉ ุงูุจูุงูุงุช

---

## ๐ ุงูุชุทููุฑ ุงููุณุชูุจูู

### ุงูุชุฑุงุญุงุช ููุชุญุณูู

1. **ุฅุดุนุงุฑุงุช:**
   - ุฅุฑุณุงู ุฅุดุนุงุฑ ูููุณุชุฎุฏู ุงููููู
   - ุฅุฑุณุงู ุฅุดุนุงุฑ ููุฏูุฑ ุงูุนูููุฉ ุงูุฌุฏูุฏุฉ

2. **ุงูุชุญูู ูู ุงูุตูุงุญูุงุช:**
   - ุงูุชุญูู ูู ุตูุงุญูุฉ ุงููุณุชุฎุฏู ูู ุงูุนูููุฉ ุงููุณุชูุฏูุฉ
   - ููุน ุงูููู ุฅุฐุง ูู ููู ุงููุณุชุฎุฏู ุนุถูุงู ูู ุงูุนูููุฉ

3. **ุณุฌู ุงูุชุงุฑูุฎ:**
   - ุญูุธ ุณุฌู ูุงูู ูุฌููุน ุนูููุงุช ุงูููู
   - ุฅููุงููุฉ ุงูุชุฑุงุฌุน ุนู ุงูููู

4. **ุงูุชุญูู ูู ุงูููุงุนุฏ:**
   - ุงูุชุญูู ูู ููุงุนุฏ ุงูุนูู (Business Rules)
   - ููุน ุงูููู ูู ุญุงูุงุช ูุนููุฉ

---

## ๐ ุงูุฏุนู

ูู ุญุงูุฉ ูุฌูุฏ ูุดุงูู ุฃู ุงุณุชูุณุงุฑุงุช:
- ุฑุงุฌุน ููู ุงูุงุฎุชุจุงุฑ: `test-move-ticket-to-process.js`
- ุชุญูู ูู ุงูุณุฌูุงุช (Logs) ูู ุงูุฎุงุฏู
- ุฑุงุฌุน ุชูุซูู Swagger: `http://localhost:3004/api-docs`

---

## โ ุงูุฎูุงุตุฉ

ุชู ุฅูุดุงุก ูุธุงู ูุชูุงูู ูููู ุงูุชุฐุงูุฑ ุจูู ุงูุนูููุงุช ูุน:
- โ ุงูุชุดุงู ุชููุงุฆู ูููุฑุญูุฉ ุงูุฃูููุฉ
- โ ุชุนููู ุชููุงุฆู ููุตู
- โ ุชุณุฌูู ูุงูู ูููุดุงุท
- โ ูุนุงููุงุช ุขููุฉ
- โ ุชูุซูู Swagger ุดุงูู
- โ ููู ุงุฎุชุจุงุฑ ูุงูู

**ุชุงุฑูุฎ ุงูุฅูุดุงุก:** 2025-10-10  
**ุงูุฅุตุฏุงุฑ:** 1.0.0  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู
