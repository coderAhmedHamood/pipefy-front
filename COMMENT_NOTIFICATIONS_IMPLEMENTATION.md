# ุฅุดุนุงุฑุงุช ุงูุชุนูููุงุช - Pipefy

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทุจูู ูุธุงู ุฅุดุนุงุฑุงุช ุชููุงุฆู ูุฑุณู ุฅุดุนุงุฑุงุช ูููุณูุฏูู ูุงููุฑุงุฌุนูู ุนูุฏ ุฅุถุงูุฉ ุชุนููู ุฌุฏูุฏ ุนูู ุงูุชุฐูุฑุฉ.

---

## โจ ุงูููุฒุฉ ุงููุทุจูุฉ

### **ุฅุดุนุงุฑ ุนูุฏ ุฅุถุงูุฉ ุชุนููู ุนูู ุงูุชุฐูุฑุฉ**

- **ุงููููุน**: `src/components/comments/CommentsSection.tsx` - ุฏุงูุฉ `handleAddComment`
- **ุงููุณุชูููู**: 
  - ุงููุณุชุฎุฏู ุงููุณูุฏ ุฅููู ุงูุฃุณุงุณู (`ticket.assigned_to`)
  - ุฌููุน ุงููุณูุฏูู ูู ุฌุฏูู `ticket_assignments`
  - ุฌููุน ุงููุฑุงุฌุนูู ูู ุฌุฏูู `ticket_reviewers`
- **ููุน ุงูุฅุดุนุงุฑ**: `comment_added`
- **API ุงููุณุชุฎุฏู**: `POST /api/notifications/bulk`
- **ุงููุญุชูู**: 
  ```
  ุงูุนููุงู: ุชุนููู ุฌุฏูุฏ ุนูู: [ุงุณู ุงูุชุฐูุฑุฉ]
  ุงูุฑุณุงูุฉ: ูุงู [ุงุณู ุงููุณุชุฎุฏู] ุจุฅุถุงูุฉ ุชุนููู ุฌุฏูุฏ ุนูู ุงูุชุฐูุฑุฉ
  ```

---

## ๐ง ุงูุชุทุจูู ุงูุชููู

### 1. **ุชุญุฏูุซ CommentsSection.tsx**

#### **ุฅุถุงูุฉ Props ุฌุฏูุฏุฉ**
```typescript
interface CommentsSectionProps {
  ticketId: string;
  ticketTitle?: string;           // ุฌุฏูุฏ
  assignedUserIds?: string[];     // ุฌุฏูุฏ
  reviewerUserIds?: string[];     // ุฌุฏูุฏ
  onCommentAdded?: (comment: Comment) => void;
}
```

#### **ุฏุงูุฉ ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช**
```typescript
const sendNotificationsForComment = async () => {
  try {
    // ุงูุญุตูู ุนูู ุงุณู ุงููุณุชุฎุฏู ุงูุญุงูู
    const userData = localStorage.getItem('user_data');
    let currentUserName = 'ูุณุชุฎุฏู';
    let currentUserId = '';
    
    if (userData) {
      try {
        const user = JSON.parse(userData);
        currentUserName = user.name || user.email || 'ูุณุชุฎุฏู';
        currentUserId = user.id || '';
      } catch (e) {
        console.error('ุฎุทุฃ ูู ูุฑุงุกุฉ ุจูุงูุงุช ุงููุณุชุฎุฏู:', e);
      }
    }
    
    // ุฌูุน ุฌููุน ูุนุฑูุงุช ุงููุณุชุฎุฏููู (ุงููุณูุฏูู + ุงููุฑุงุฌุนูู)
    const allUserIds = [...assignedUserIds, ...reviewerUserIds]
      .filter(id => id && id !== currentUserId); // ุงุณุชุจุนุงุฏ ุงููุณุชุฎุฏู ุงูุญุงูู
    
    // ุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช
    const uniqueUserIds = Array.from(new Set(allUserIds));
    
    if (uniqueUserIds.length === 0) {
      console.log('โน๏ธ ูุง ููุฌุฏ ูุณุชุฎุฏููู ูุฅุฑุณุงู ุฅุดุนุงุฑุงุช ุฅูููู');
      return;
    }
    
    console.log(`๐ง ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูู ${uniqueUserIds.length} ูุณุชุฎุฏู`);
    
    // ุฅุฑุณุงู ุฅุดุนุงุฑ ุฌูุงุนู
    await notificationService.sendBulkNotification({
      user_ids: uniqueUserIds,
      title: `ุชุนููู ุฌุฏูุฏ ุนูู: ${ticketTitle}`,
      message: `ูุงู ${currentUserName} ุจุฅุถุงูุฉ ุชุนููู ุฌุฏูุฏ ุนูู ุงูุชุฐูุฑุฉ`,
      notification_type: 'comment_added',
      action_url: `/tickets/${ticketId}`
    });
    
    console.log('โ ุชู ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช ุจูุฌุงุญ');
  } catch (error) {
    console.error('โ ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช:', error);
    // ูุง ูููู ุงูุนูููุฉ ุฅุฐุง ูุดู ุงูุฅุดุนุงุฑ
  }
};
```

#### **ุชุญุฏูุซ handleAddComment**
```typescript
const handleAddComment = async () => {
  if (!newComment.trim() || isSubmitting) return;

  setIsSubmitting(true);
  try {
    const comment = await addComment({
      content: newComment.trim(),
      is_internal: false
    });

    if (comment) {
      setNewComment('');
      setIsAddingComment(false);
      onCommentAdded?.(comment);
      
      // ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูููุณูุฏูู ูุงููุฑุงุฌุนูู
      await sendNotificationsForComment();
    }
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูุชุนููู:', error);
  } finally {
    setIsSubmitting(false);
  }
};
```

### 2. **ุชุญุฏูุซ TicketModal.tsx**

#### **ุชูุฑูุฑ ุงูุจูุงูุงุช ุฅูู CommentsSection**
```typescript
<CommentsSection
  ticketId={ticket.id}
  ticketTitle={ticket.title}
  assignedUserIds={[
    ...(ticket.assigned_to ? [ticket.assigned_to] : []),
    ...assignments.map(a => a.user_id).filter(Boolean)
  ]}
  reviewerUserIds={reviewers.map(r => r.reviewer_id).filter(Boolean)}
  onCommentAdded={(comment) => {
    console.log('ุชู ุฅุถุงูุฉ ุชุนููู ุฌุฏูุฏ:', comment);
  }}
/>
```

---

## ๐ฏ ุขููุฉ ุงูุนูู

### 1. **ุฌูุน ุงููุณุชุฎุฏููู ุงููุณุชูุฏููู**
```typescript
// ุงููุณูุฏ ุฅููู ุงูุฃุณุงุณู
ticket.assigned_to

// ุงููุณูุฏูู ุงูุฅุถุงูููู
assignments.map(a => a.user_id)

// ุงููุฑุงุฌุนูู
reviewers.map(r => r.reviewer_id)
```

### 2. **ุชุตููุฉ ุงููุณุชุฎุฏููู**
- **ุงุณุชุจุนุงุฏ ุงููุณุชุฎุฏู ุงูุญุงูู**: ูุง ูุชููู ุฅุดุนุงุฑ ุนู ุชุนูููู ุงูุฎุงุต
- **ุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช**: ุงุณุชุฎุฏุงู `Set` ูุถูุงู ุนุฏู ุชูุฑุงุฑ ุงูุฅุดุนุงุฑุงุช
- **ุชุตููุฉ ุงูููู ุงููุงุฑุบุฉ**: ุงุณุชุฎุฏุงู `filter(Boolean)`

### 3. **ุฅุฑุณุงู ุงูุฅุดุนุงุฑ ุงูุฌูุงุนู**
```typescript
await notificationService.sendBulkNotification({
  user_ids: uniqueUserIds,           // ูุตูููุฉ ูุนุฑูุงุช ุงููุณุชุฎุฏููู
  title: 'ุชุนููู ุฌุฏูุฏ ุนูู: [ุงุณู ุงูุชุฐูุฑุฉ]',
  message: 'ูุงู [ุงุณู ุงููุณุชุฎุฏู] ุจุฅุถุงูุฉ ุชุนููู ุฌุฏูุฏ',
  notification_type: 'comment_added',
  action_url: '/tickets/[ticket_id]'
});
```

### 4. **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก**
- ุงูุฅุดุนุงุฑุงุช ูุง ุชููู ุนูููุฉ ุฅุถุงูุฉ ุงูุชุนููู
- ุฅุฐุง ูุดู ุฅุฑุณุงู ุงูุฅุดุนุงุฑุ ูุชู ุชุณุฌูู ุงูุฎุทุฃ ูุงูุงุณุชูุฑุงุฑ
- ุงูุชุนููู ููุถุงู ุจูุฌุงุญ ุญุชู ูู ูุดู ุงูุฅุดุนุงุฑ

---

## ๐ ูุซุงู ุนูู ุณูุฑ ุงูุนูู

### ุณููุงุฑูู: ุฅุถุงูุฉ ุชุนููู ุนูู ุชุฐูุฑุฉ

1. **ุงููุณุชุฎุฏู ูุถูู ุชุนููู**
   ```
   ุงููุณุชุฎุฏู: ุฃุญูุฏ ูุญูุฏ
   ุงูุชุฐูุฑุฉ: "ูุดููุฉ ูู ุงููุธุงู"
   ุงูุชุนููู: "ุชู ุญู ุงููุดููุฉ"
   ```

2. **ุงููุธุงู ูุฌูุน ุงููุณุชุฎุฏููู ุงููุณุชูุฏููู**
   ```
   ุงููุณูุฏ ุฅููู: user-123
   ุงููุณูุฏูู: [user-456, user-789]
   ุงููุฑุงุฌุนูู: [user-101, user-102]
   
   ุงููุฌููุน: 5 ูุณุชุฎุฏููู
   ```

3. **ุงููุธุงู ูุตูู ุงููุณุชุฎุฏููู**
   ```
   - ุงุณุชุจุนุงุฏ ุฃุญูุฏ ูุญูุฏ (ุงููุณุชุฎุฏู ุงูุญุงูู)
   - ุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช
   
   ุงููุชูุฌุฉ: 4 ูุณุชุฎุฏููู ูุฑูุฏูู
   ```

4. **ุงููุธุงู ูุฑุณู ุฅุดุนุงุฑ ุฌูุงุนู**
   ```
   POST /api/notifications/bulk
   {
     "user_ids": ["user-123", "user-456", "user-789", "user-101"],
     "title": "ุชุนููู ุฌุฏูุฏ ุนูู: ูุดููุฉ ูู ุงููุธุงู",
     "message": "ูุงู ุฃุญูุฏ ูุญูุฏ ุจุฅุถุงูุฉ ุชุนููู ุฌุฏูุฏ ุนูู ุงูุชุฐูุฑุฉ",
     "notification_type": "comment_added",
     "action_url": "/tickets/ticket-001"
   }
   ```

5. **ุงููุณุชุฎุฏููู ูุชูููู ุงูุฅุดุนุงุฑุงุช**
   - ูุธูุฑ ุงูุฅุดุนุงุฑ ูู ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช
   - ูููู ุงูููุฑ ุนูู ุงูุฅุดุนุงุฑ ููุงูุชูุงู ููุชุฐูุฑุฉ
   - ุงูุฅุดุนุงุฑ ูุญุชูู ุนูู ุฑุงุจุท ูุจุงุดุฑ: `/tickets/ticket-001`

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

### Frontend
1. **`src/components/comments/CommentsSection.tsx`**
   - ุฅุถุงูุฉ ุงุณุชูุฑุงุฏ `notificationService`
   - ุฅุถุงูุฉ props: `ticketTitle`, `assignedUserIds`, `reviewerUserIds`
   - ุฅุถุงูุฉ ุฏุงูุฉ `sendNotificationsForComment`
   - ุชุญุฏูุซ `handleAddComment` ูุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช

2. **`src/components/kanban/TicketModal.tsx`**
   - ุชุญุฏูุซ ุงุณุชุฏุนุงุก `CommentsSection` ูุชูุฑูุฑ ุงูุจูุงูุงุช ุงููุทููุจุฉ

---

## ๐ ููุน ุงูุฅุดุนุงุฑ

| ุงูููุน | ุงููุตู | ุงูุงุณุชุฎุฏุงู |
|------|-------|----------|
| `comment_added` | ุชุนููู ุฌุฏูุฏ | ุนูุฏ ุฅุถุงูุฉ ุชุนููู ุนูู ุงูุชุฐูุฑุฉ |

---

## โ ุงูููุงุฆุฏ

1. **ุชูุงุตู ููุฑู**: ุงููุณุชุฎุฏููู ุงููุนูููู ูุชูููู ุฅุดุนุงุฑุงุช ููุฑูุฉ
2. **ุชุชุจุน ุดุงูู**: ุฌููุน ุงููุณูุฏูู ูุงููุฑุงุฌุนูู ุนูู ุนูู ุจุงูุชุญุฏูุซุงุช
3. **ููุงุกุฉ ุนุงููุฉ**: ุงุณุชุฎุฏุงู bulk API ูุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูุชุนุฏุฏุฉ ุจุทูุจ ูุงุญุฏ
4. **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ูุญุณูุฉ**: ุฅุดุนุงุฑุงุช ุฐููุฉ ูุง ุชุฒุนุฌ ุงููุณุชุฎุฏู ุงูุญุงูู
5. **ููุซูููุฉ**: ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญููุฉ ูุง ุชููู ุงูุนูููุฉ ุงูุฃุณุงุณูุฉ

---

## ๐ ุงูุงุณุชุฎุฏุงู

ุงููุธุงู ูุนูู **ุชููุงุฆูุงู**! ูุง ุญุงุฌุฉ ูุฃู ุฅุนุฏุงุฏ ุฅุถุงูู.

### ูููุณุชุฎุฏููู:
1. ุงูุชุญ ุฃู ุชุฐูุฑุฉ
2. ุฃุถู ุชุนููู ุฌุฏูุฏ
3. ุงููุธุงู ุณูุฑุณู ุฅุดุนุงุฑุงุช ุชููุงุฆูุฉ ูุฌููุน ุงููุณูุฏูู ูุงููุฑุงุฌุนูู
4. ูููููู ุฑุคูุฉ ุงูุฅุดุนุงุฑุงุช ูู ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช

### ูููุทูุฑูู:
- ุงููุธุงู ูุณุชุฎุฏู `notificationService.sendBulkNotification`
- ูููู ุชุฎุตูุต ูุญุชูู ุงูุฅุดุนุงุฑ ูู ุฏุงูุฉ `sendNotificationsForComment`
- ูููู ุฅุถุงูุฉ ุฃููุงุน ุฅุดุนุงุฑุงุช ุฌุฏูุฏุฉ ุจุณูููุฉ

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงูุฅุดุนุงุฑุงุช ุบูุฑ ูุชุฒุงููุฉ**: ูุง ุชุคุซุฑ ุนูู ุฃุฏุงุก ุฅุถุงูุฉ ุงูุชุนููู
2. **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก**: ูุดู ุงูุฅุดุนุงุฑ ูุง ูููู ุฅุถุงูุฉ ุงูุชุนููู
3. **ุงุณุชุซูุงุก ุงููุณุชุฎุฏู ุงูุญุงูู**: ูุง ูุชููู ุฅุดุนุงุฑ ุนู ุชุนูููู ุงูุฎุงุต
4. **ุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช**: ูู ูุณุชุฎุฏู ูุชููู ุฅุดุนุงุฑ ูุงุญุฏ ููุท
5. **ุฑุงุจุท ูุจุงุดุฑ**: ูู ุฅุดุนุงุฑ ูุญุชูู ุนูู ุฑุงุจุท ููุชุฐูุฑุฉ

---

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

ูุธุงู ุฅุดุนุงุฑุงุช ุชููุงุฆู ููุชุนูููุงุช ูุนูู ุจููุงุกุฉ ุนุงููุฉ:
- โ ุฅุดุนุงุฑุงุช ููุฑูุฉ ูููุณูุฏูู ูุงููุฑุงุฌุนูู
- โ ุงุณุชุฎุฏุงู bulk API ูุฅุฑุณุงู ูุชุนุฏุฏ
- โ ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญููุฉ
- โ ุชุตููุฉ ุฐููุฉ ูููุณุชุฎุฏููู
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ูุญุณูุฉ

**ุชู ุงูุชุทุจูู ุจูุฌุงุญ! ๐**
