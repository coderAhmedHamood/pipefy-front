# ุฅุดุนุงุฑุงุช ุชุญุฑูู ุงูุชุฐุงูุฑ - Pipefy

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทุจูู ูุธุงู ุฅุดุนุงุฑุงุช ุชููุงุฆู ูุฑุณู ุฅุดุนุงุฑุงุช ูุฌููุน ุงููุณูุฏูู ูุงููุฑุงุฌุนูู ุนูุฏ ุชุญุฑูู ุงูุชุฐูุฑุฉ ูู ูุฑุญูุฉ ุฅูู ุฃุฎุฑู.

---

## โจ ุงูููุฒุฉ ุงููุทุจูุฉ

### **ุฅุดุนุงุฑ ุนูุฏ ุชุญุฑูู ุงูุชุฐูุฑุฉ ุจูู ุงููุฑุงุญู**

- **ุงููููุน**: `api/routes/tickets.js` - endpoint `POST /api/tickets/:id/move-simple`
- **ุงููุณุชูููู**: 
  - ุงููุณุชุฎุฏู ุงููุณูุฏ ุฅููู ุงูุฃุณุงุณู (`ticket.assigned_to`)
  - ุฌููุน ุงููุณูุฏูู ูู ุฌุฏูู `ticket_assignments`
  - ุฌููุน ุงููุฑุงุฌุนูู ูู ุฌุฏูู `ticket_reviewers`
  - **ุจุฏูู ุงุณุชุซูุงุก**: ูุชููู ุงูุฌููุน ุงูุฅุดุนุงุฑ ุญุชู ุงููุณุชุฎุฏู ุงูุฐู ูุงู ุจุงูุชุญุฑูู
- **ููุน ุงูุฅุดุนุงุฑ**: `ticket_moved`
- **ุงูุดุฑุท**: ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ููุท ุฅุฐุง ูุงู ููุงู ูุณุชุฎุฏููู ูุณูุฏูู ุฃู ูุฑุงุฌุนูู
- **ุงููุญุชูู**: 
  ```
  ุงูุนููุงู: ุชู ุชุญุฑูู ุงูุชุฐูุฑุฉ: [ุงุณู ุงูุชุฐูุฑุฉ]
  ุงูุฑุณุงูุฉ: ูุงู [ุงุณู ุงููุณุชุฎุฏู] ุจููู ุงูุชุฐูุฑุฉ ูู "[ุงููุฑุญูุฉ ุงูุณุงุจูุฉ]" ุฅูู "[ุงููุฑุญูุฉ ุงูุฌุฏูุฏุฉ]"
  ```

---

## ๐ง ุงูุชุทุจูู ุงูุชููู

### **ุชุญุฏูุซ endpoint `/move-simple`**

#### **ุงูููุฏ ุงููุถุงู**
```javascript
// 5.5. ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูููุณูุฏูู ูุงููุฑุงุฌุนูู
try {
  // ุฌูุน ูุนุฑูุงุช ุงููุณุชุฎุฏููู (ุงููุณูุฏ ุฅููู + ุงููุณูุฏูู + ุงููุฑุงุฌุนูู)
  const userIds = [];
  
  // ุฅุถุงูุฉ ุงููุณูุฏ ุฅููู ุงูุฃุณุงุณู
  if (ticket.assigned_to) {
    userIds.push(ticket.assigned_to);
  }
  
  // ุฅุถุงูุฉ ุฌููุน ุงููุณูุฏูู ูู ุฌุฏูู ticket_assignments
  const assignmentsResult = await pool.query(
    'SELECT user_id FROM ticket_assignments WHERE ticket_id = $1',
    [ticketId]
  );
  assignmentsResult.rows.forEach(row => {
    if (row.user_id) userIds.push(row.user_id);
  });
  
  // ุฅุถุงูุฉ ุฌููุน ุงููุฑุงุฌุนูู ูู ุฌุฏูู ticket_reviewers
  const reviewersResult = await pool.query(
    'SELECT reviewer_id FROM ticket_reviewers WHERE ticket_id = $1',
    [ticketId]
  );
  reviewersResult.rows.forEach(row => {
    if (row.reviewer_id) userIds.push(row.reviewer_id);
  });
  
  // ุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช
  const uniqueUserIds = [...new Set(userIds)];
  
  // ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ููุท ุฅุฐุง ูุงู ููุงู ูุณุชุฎุฏููู
  if (uniqueUserIds.length > 0) {
    console.log(`๐ง ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูู ${uniqueUserIds.length} ูุณุชุฎุฏู`);
    
    // ุฅูุดุงุก ุฅุดุนุงุฑุงุช ูุฌููุน ุงููุณุชุฎุฏููู
    for (const userId of uniqueUserIds) {
      await pool.query(`
        INSERT INTO notifications (
          user_id, title, message, notification_type, 
          action_url, created_at
        ) VALUES ($1, $2, $3, $4, $5, NOW())
      `, [
        userId,
        `ุชู ุชุญุฑูู ุงูุชุฐูุฑุฉ: ${ticket.title}`,
        `ูุงู ${userName} ุจููู ุงูุชุฐูุฑุฉ ูู "${ticket.current_stage_name}" ุฅูู "${targetStage.name}"`,
        'ticket_moved',
        `/tickets/${ticketId}`
      ]);
    }
    
    console.log('โ ุชู ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช ุจูุฌุงุญ');
  } else {
    console.log('โน๏ธ ูุง ููุฌุฏ ูุณุชุฎุฏููู ูุฅุฑุณุงู ุฅุดุนุงุฑุงุช ุฅูููู');
  }
} catch (notificationError) {
  console.error('โ ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช:', notificationError);
  // ูุณุชูุฑ ูู ุงูุนูููุฉ ุญุชู ูู ูุดูุช ุงูุฅุดุนุงุฑุงุช
}
```

---

## ๐ฏ ุขููุฉ ุงูุนูู

### 1. **ุฌูุน ุงููุณุชุฎุฏููู ุงููุณุชูุฏููู**
```javascript
// ุงููุณูุฏ ุฅููู ุงูุฃุณุงุณู
ticket.assigned_to

// ุงููุณูุฏูู ุงูุฅุถุงูููู
SELECT user_id FROM ticket_assignments WHERE ticket_id = ?

// ุงููุฑุงุฌุนูู
SELECT reviewer_id FROM ticket_reviewers WHERE ticket_id = ?
```

### 2. **ุชุตููุฉ ุงููุณุชุฎุฏููู**
- **ุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช**: ุงุณุชุฎุฏุงู `Set` ูุถูุงู ุนุฏู ุชูุฑุงุฑ ุงูุฅุดุนุงุฑุงุช
- **ุชุตููุฉ ุงูููู ุงููุงุฑุบุฉ**: ููุท ุงููุนุฑูุงุช ุงูุตุญูุญุฉ
- **ุจุฏูู ุงุณุชุซูุงุก**: ุฌููุน ุงููุณุชุฎุฏููู ูุชูููู ุงูุฅุดุนุงุฑ (ุญุชู ูู ูุงู ุจุงูุชุญุฑูู)

### 3. **ุงูุดุฑุท ุงูุฃุณุงุณู**
```javascript
if (uniqueUserIds.length > 0) {
  // ุฅุฑุณุงู ุฅุดุนุงุฑุงุช
} else {
  // ูุง ููุฌุฏ ูุณุชุฎุฏููู - ูุง ุชุฑุณู ุฅุดุนุงุฑุงุช
}
```

### 4. **ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช**
```javascript
for (const userId of uniqueUserIds) {
  await pool.query(`
    INSERT INTO notifications (
      user_id, title, message, notification_type, 
      action_url, created_at
    ) VALUES ($1, $2, $3, $4, $5, NOW())
  `, [
    userId,
    'ุชู ุชุญุฑูู ุงูุชุฐูุฑุฉ: [ุงุณู ุงูุชุฐูุฑุฉ]',
    'ูุงู [ุงุณู ุงููุณุชุฎุฏู] ุจููู ุงูุชุฐูุฑุฉ ูู "[ุงููุฑุญูุฉ ุงูุณุงุจูุฉ]" ุฅูู "[ุงููุฑุญูุฉ ุงูุฌุฏูุฏุฉ]"',
    'ticket_moved',
    '/tickets/[ticket_id]'
  ]);
}
```

### 5. **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก**
- ุงูุฅุดุนุงุฑุงุช ูุง ุชููู ุนูููุฉ ุชุญุฑูู ุงูุชุฐูุฑุฉ
- ุฅุฐุง ูุดู ุฅุฑุณุงู ุงูุฅุดุนุงุฑุ ูุชู ุชุณุฌูู ุงูุฎุทุฃ ูุงูุงุณุชูุฑุงุฑ
- ุงูุชุฐูุฑุฉ ุชูุญุฑู ุจูุฌุงุญ ุญุชู ูู ูุดู ุงูุฅุดุนุงุฑ

---

## ๐ ูุซุงู ุนูู ุณูุฑ ุงูุนูู

### ุณููุงุฑูู: ุชุญุฑูู ุชุฐูุฑุฉ ูู "ููุฏ ุงููุฑุงุฌุนุฉ" ุฅูู "ููุชูู"

1. **ุงููุณุชุฎุฏู ูุญุฑู ุงูุชุฐูุฑุฉ**
   ```
   ุงููุณุชุฎุฏู: ุฃุญูุฏ ูุญูุฏ
   ุงูุชุฐูุฑุฉ: "ูุดููุฉ ูู ุงููุธุงู"
   ูู: "ููุฏ ุงููุฑุงุฌุนุฉ"
   ุฅูู: "ููุชูู"
   ```

2. **ุงููุธุงู ูุฌูุน ุงููุณุชุฎุฏููู ุงููุณุชูุฏููู**
   ```
   ุงููุณูุฏ ุฅููู: user-123
   ุงููุณูุฏูู: [user-456, user-789]
   ุงููุฑุงุฌุนูู: [user-101, user-102]
   
   ุงููุฌููุน: 5 ูุณุชุฎุฏููู
   ```

3. **ุงููุธุงู ูุตูู ุงููุณุชุฎุฏููู**
   ```
   - ุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช
   - ุจุฏูู ุงุณุชุซูุงุก (ุญุชู ุฃุญูุฏ ูุญูุฏ ูุชููู ุงูุฅุดุนุงุฑ)
   
   ุงููุชูุฌุฉ: 5 ูุณุชุฎุฏููู ูุฑูุฏูู
   ```

4. **ุงููุธุงู ูุฑุณู ุงูุฅุดุนุงุฑุงุช**
   ```
   INSERT INTO notifications
   - user-123: "ุชู ุชุญุฑูู ุงูุชุฐูุฑุฉ: ูุดููุฉ ูู ุงููุธุงู"
   - user-456: "ุชู ุชุญุฑูู ุงูุชุฐูุฑุฉ: ูุดููุฉ ูู ุงููุธุงู"
   - user-789: "ุชู ุชุญุฑูู ุงูุชุฐูุฑุฉ: ูุดููุฉ ูู ุงููุธุงู"
   - user-101: "ุชู ุชุญุฑูู ุงูุชุฐูุฑุฉ: ูุดููุฉ ูู ุงููุธุงู"
   - user-102: "ุชู ุชุญุฑูู ุงูุชุฐูุฑุฉ: ูุดููุฉ ูู ุงููุธุงู"
   ```

5. **ุงููุณุชุฎุฏููู ูุชูููู ุงูุฅุดุนุงุฑุงุช**
   - ูุธูุฑ ุงูุฅุดุนุงุฑ ูู ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช
   - ูููู ุงูููุฑ ุนูู ุงูุฅุดุนุงุฑ ููุงูุชูุงู ููุชุฐูุฑุฉ
   - ุงูุฅุดุนุงุฑ ูุญุชูู ุนูู ุฑุงุจุท ูุจุงุดุฑ: `/tickets/ticket-001`

---

## ๐ ุงูุญุงูุงุช ุงูุฎุงุตุฉ

### **1. ุชุฐูุฑุฉ ุจุฏูู ูุณูุฏูู ุฃู ูุฑุงุฌุนูู**
```
ุงููุณูุฏ ุฅููู: null
ุงููุณูุฏูู: []
ุงููุฑุงุฌุนูู: []

ุงููุชูุฌุฉ: โ ูุง ูุชู ุฅุฑุณุงู ุฃู ุฅุดุนุงุฑุงุช
```

### **2. ุชุฐูุฑุฉ ูุน ูุณูุฏ ุฅููู ููุท**
```
ุงููุณูุฏ ุฅููู: user-123
ุงููุณูุฏูู: []
ุงููุฑุงุฌุนูู: []

ุงููุชูุฌุฉ: โ ูุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ูู user-123 ููุท
```

### **3. ุชุฐูุฑุฉ ูุน ูุณูุฏูู ููุฑุงุฌุนูู**
```
ุงููุณูุฏ ุฅููู: user-123
ุงููุณูุฏูู: [user-456, user-789]
ุงููุฑุงุฌุนูู: [user-101]

ุงููุชูุฌุฉ: โ ูุชู ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูู 4 ูุณุชุฎุฏููู
```

### **4. ุชุฐูุฑุฉ ูุน ุชูุฑุงุฑุงุช**
```
ุงููุณูุฏ ุฅููู: user-123
ุงููุณูุฏูู: [user-123, user-456]
ุงููุฑุงุฌุนูู: [user-456]

ุงููุชูุฌุฉ: โ ูุชู ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูู 2 ูุณุชุฎุฏููู ููุท (user-123, user-456)
```

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

### Backend
- โ `api/routes/tickets.js` - ุชุญุฏูุซ endpoint `/move-simple`

---

## ๐ ููุน ุงูุฅุดุนุงุฑ

| ุงูููุน | ุงููุตู | ุงูุงุณุชุฎุฏุงู |
|------|-------|----------|
| `ticket_moved` | ุชุญุฑูู ุชุฐูุฑุฉ | ุนูุฏ ููู ุงูุชุฐูุฑุฉ ูู ูุฑุญูุฉ ุฅูู ุฃุฎุฑู |

---

## โ ุงูููุงุฆุฏ

1. **ุชูุงุตู ุดุงูู**: ุฌููุน ุงููุนูููู ูุชูููู ุฅุดุนุงุฑุงุช ููุฑูุฉ
2. **ุจุฏูู ุงุณุชุซูุงุก**: ุญุชู ูู ูุงู ุจุงูุชุญุฑูู ูุชููู ุงูุฅุดุนุงุฑ ููุชูุซูู
3. **ุฐูุงุก ูู ุงูุฅุฑุณุงู**: ูุง ูุชู ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ุฅุฐุง ูู ููู ููุงู ูุณุชุฎุฏููู
4. **ููุซูููุฉ**: ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญููุฉ ูุง ุชููู ุงูุนูููุฉ ุงูุฃุณุงุณูุฉ
5. **ุชุชุจุน ูุงูู**: ุณุฌู ูุงูู ูุฌููุน ุชุญุฑูุงุช ุงูุชุฐูุฑุฉ

---

## ๐ ุงูุงุณุชุฎุฏุงู

ุงููุธุงู ูุนูู **ุชููุงุฆูุงู**! ูุง ุญุงุฌุฉ ูุฃู ุฅุนุฏุงุฏ ุฅุถุงูู.

### ูููุณุชุฎุฏููู:
1. ุญุฑู ุฃู ุชุฐูุฑุฉ ูู ูุฑุญูุฉ ุฅูู ุฃุฎุฑู
2. ุงููุธุงู ุณูุฑุณู ุฅุดุนุงุฑุงุช ุชููุงุฆูุฉ ูุฌููุน ุงููุณูุฏูู ูุงููุฑุงุฌุนูู
3. ูููููู ุฑุคูุฉ ุงูุฅุดุนุงุฑุงุช ูู ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช

### ูููุทูุฑูู:
- ุงููุธุงู ูุนูู ูู endpoint `/move-simple`
- ูููู ุชุฎุตูุต ูุญุชูู ุงูุฅุดุนุงุฑ ูู ุงูููุฏ
- ูููู ุฅุถุงูุฉ ุดุฑูุท ุฅุถุงููุฉ ุจุณูููุฉ

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงูุฅุดุนุงุฑุงุช ุบูุฑ ูุชุฒุงููุฉ**: ูุง ุชุคุซุฑ ุนูู ุฃุฏุงุก ุชุญุฑูู ุงูุชุฐูุฑุฉ
2. **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก**: ูุดู ุงูุฅุดุนุงุฑ ูุง ูููู ุชุญุฑูู ุงูุชุฐูุฑุฉ
3. **ุจุฏูู ุงุณุชุซูุงุก**: ุฌููุน ุงููุณุชุฎุฏููู ูุชูููู ุงูุฅุดุนุงุฑ (ุญุชู ูู ูุงู ุจุงูุชุญุฑูู)
4. **ุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช**: ูู ูุณุชุฎุฏู ูุชููู ุฅุดุนุงุฑ ูุงุญุฏ ููุท
5. **ุฑุงุจุท ูุจุงุดุฑ**: ูู ุฅุดุนุงุฑ ูุญุชูู ุนูู ุฑุงุจุท ููุชุฐูุฑุฉ
6. **ุดุฑุท ุงูุฅุฑุณุงู**: ูุง ูุชู ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ุฅุฐุง ูู ููู ููุงู ูุณูุฏูู ุฃู ูุฑุงุฌุนูู

---

## ๐ ุงููุฑู ุนู ุฅุดุนุงุฑุงุช ุงูุชุนูููุงุช

| ุงูููุฒุฉ | ุฅุดุนุงุฑุงุช ุงูุชุนูููุงุช | ุฅุดุนุงุฑุงุช ุงูุชุญุฑูู |
|--------|-------------------|------------------|
| **ุงููููุน** | Frontend (CommentsSection) | Backend (move-simple endpoint) |
| **API** | POST /api/notifications/bulk | INSERT INTO notifications |
| **ุงุณุชุซูุงุก ุงููุณุชุฎุฏู ุงูุญุงูู** | โ ูุนู | โ ูุง |
| **ุงูุดุฑุท** | ุฏุงุฆูุงู ูุฑุณู | ููุท ุฅุฐุง ูุงู ููุงู ูุณุชุฎุฏููู |
| **ุงูููุน** | comment_added | ticket_moved |

---

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

ูุธุงู ุฅุดุนุงุฑุงุช ุชููุงุฆู ูุชุญุฑูู ุงูุชุฐุงูุฑ ูุนูู ุจููุงุกุฉ ุนุงููุฉ:
- โ ุฅุดุนุงุฑุงุช ููุฑูุฉ ูุฌููุน ุงููุณูุฏูู ูุงููุฑุงุฌุนูู
- โ ุจุฏูู ุงุณุชุซูุงุก (ุงูุฌููุน ูุชููู ุงูุฅุดุนุงุฑ)
- โ ุฐูุงุก ูู ุงูุฅุฑุณุงู (ูุง ูุฑุณู ุฅุฐุง ูู ููู ููุงู ูุณุชุฎุฏููู)
- โ ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญููุฉ
- โ ุชุตููุฉ ุฐููุฉ ููุชูุฑุงุฑุงุช
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ูุญุณูุฉ

**ุชู ุงูุชุทุจูู ุจูุฌุงุญ! ๐**
